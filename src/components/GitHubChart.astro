---
// GitHub contribution chart with graceful fallback
// Shows shimmer loading state, falls back to text link if blocked/timeout
---

<div
  id="github-chart"
  class="bg-secondary p-0 rounded-lg img-loading"
  style="min-height: 120px;"
>
  <img
    src="https://ghchart.rshah.org/justcarlson"
    alt="Just Carlson's GitHub Contribution Graph"
    class="w-full"
    style="max-width: 100%; height: auto;"
  />
</div>

<script>
  function setupGitHubChartFallback() {
    const container = document.getElementById('github-chart');
    const img = container?.querySelector('img');
    if (!img || !container) return;

    // Check if image is successfully loaded
    const isImageLoaded = () => img.complete && img.naturalHeight > 0;

    // If image already loaded (cached), remove loading state and exit
    if (isImageLoaded()) {
      container.classList.remove('img-loading');
      return;
    }

    const TIMEOUT_MS = 5000;
    const POLL_INTERVAL_MS = 100;
    let timeoutId: ReturnType<typeof setTimeout>;
    let pollId: ReturnType<typeof setInterval>;

    const cleanup = () => {
      clearTimeout(timeoutId);
      clearInterval(pollId);
      img.onerror = null;
      img.onload = null;
    };

    const handleSuccess = () => {
      cleanup();
      container.classList.remove('img-loading');
    };

    const showFallback = () => {
      cleanup();
      container.classList.remove('img-loading');
      container.innerHTML = `<p class="p-4 text-center"><a href="https://github.com/justcarlson" class="text-accent underline">View my contributions on GitHub</a></p>`;
    };

    img.onerror = showFallback;
    img.onload = handleSuccess;

    // Poll for image completion (handles Edge deferred load events)
    pollId = setInterval(() => {
      if (isImageLoaded()) {
        handleSuccess();
      }
    }, POLL_INTERVAL_MS);

    // Timeout for blocked/slow loads
    timeoutId = setTimeout(showFallback, TIMEOUT_MS);
  }

  setupGitHubChartFallback();
  document.addEventListener('astro:page-load', setupGitHubChartFallback);
</script>
