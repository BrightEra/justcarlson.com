# Milestone v0.4.0: Obsidian + Blog Integration Refactor

**Status:** SHIPPED 2026-02-02
**Phases:** 15-17
**Total Plans:** 8

## Overview

This milestone eliminates technical debt in the publishing workflow by consolidating ~280 lines of duplicated code into a shared library, replacing fragile sed/regex YAML manipulation with yq, implementing two-way sync between Obsidian and blog metadata, and migrating from `status: Published` to `draft: false` as the canonical field. Three phases: foundation (library + tooling), features (two-way sync), then migration (schema cleanup).

## Phases

### Phase 15: Library Extraction + yq Integration

**Goal**: Eliminate code duplication and establish reliable YAML manipulation patterns
**Depends on**: Nothing (first phase of v0.4.0)
**Plans**: 2 plans

Plans:
- [x] 15-01-PLAN.md — Install yq in devcontainer + create common.sh skeleton with constants
- [x] 15-02-PLAN.md — Extract functions to common.sh + migrate all scripts to source it

**Details:**
- Added mikefarah/yq v4 to devcontainer via jq-likes feature
- Created scripts/lib/common.sh with source guard pattern
- Defined color constants, configuration constants, exit codes
- Added 8 functions: extract_frontmatter, get_frontmatter_field, validate_iso8601, validate_frontmatter, slugify, load_config, extract_frontmatter_value, yq detection helpers
- Migrated all 5 scripts to source common.sh
- Removed ~360 lines of duplicate code

### Phase 16: Two-Way Sync

**Goal**: Bidirectional metadata sync keeps Obsidian source and blog copy consistent
**Depends on**: Phase 15 (uses yq patterns and common.sh)
**Plans**: 4 plans

Plans:
- [x] 16-01-PLAN.md — Add update_obsidian_source and get_author_from_config functions to common.sh
- [x] 16-02-PLAN.md — Extend publish.sh with two-way sync and config-driven author
- [x] 16-03-PLAN.md — Extend unpublish.sh with --dry-run flag and Obsidian source sync
- [x] 16-04-PLAN.md — (gap closure) Fix discovery to use draft: false instead of status: Published

**Details:**
- get_author_from_config reads author from settings.local.json using jq
- update_obsidian_source modifies Obsidian source files with yq
- Creates .bak backup before any modification
- publish.sh calls update_obsidian_source after each post is successfully copied
- unpublish.sh automatically sets draft: true in Obsidian source file
- Added --dry-run flag for safe preview of unpublish operation
- Fixed discovery to use draft: false pattern

### Phase 17: Schema Migration

**Goal**: `draft: true/false` becomes the single source of truth for publish state
**Depends on**: Phase 16 (sync must work before changing source of truth)
**Plans**: 2 plans

Plans:
- [x] 17-01-PLAN.md — Create and execute migrate-schema.sh for existing vault posts
- [x] 17-02-PLAN.md — Update Obsidian template, types.json, views, and Astro schema

**Details:**
- Created standalone migration script with --dry-run, --verbose, and --help flags
- Successfully migrated all 4 vault posts
- Preserved existing draft values from Phase 16 sync operations
- Removed deprecated status and published fields from all posts
- Post Template simplified: draft: true as default, no status/published fields
- Obsidian types.json: draft as checkbox, pubDatetime as datetime
- Posts.base view: shows draft column, sorts by created date
- Astro schema: deprecated fields marked with comments

---

## Milestone Summary

**Key Decisions:**
- Used mikefarah/yq (Go version) instead of kislyuk/yq (Python) for --front-matter flag
- get_author_from_config returns empty (no fallback) - caller decides fallback behavior
- update_obsidian_source creates .bak backup before any modification
- Used strenv() pattern for passing shell variables to yq expressions
- Discovery uses case-insensitive draft: false pattern
- Field order: content first (title, description), then metadata (draft, dates)
- Deprecated fields kept in Astro schema for backward compatibility

**Issues Resolved:**
- ~280 lines of duplicated code consolidated into shared library
- Fragile sed/regex YAML manipulation replaced with yq
- Discovery pattern aligned with two-way sync schema (draft: false)
- Boolean false detection in yq fixed using has() check

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None - all implementations are substantive with proper error handling

---

_For current project status, see .planning/PROJECT.md_
