---
phase: 18-image-caption-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content.config.ts
  - src/layouts/PostDetails.astro
autonomous: true

must_haves:
  truths:
    - "Hero images display meaningful alt text (heroImageAlt or title fallback)"
    - "Hero images with heroImageCaption show caption below image"
    - "Existing posts without new fields render correctly (backward compatible)"
    - "Inline figure/figcaption in post body displays with prose styling"
  artifacts:
    - path: "src/content.config.ts"
      provides: "heroImageAlt and heroImageCaption schema fields"
      contains: "heroImageAlt: z.string().optional()"
    - path: "src/layouts/PostDetails.astro"
      provides: "Hero image with figure wrapper and conditional figcaption"
      contains: "<figure"
  key_links:
    - from: "src/layouts/PostDetails.astro"
      to: "src/content.config.ts"
      via: "destructured heroImageAlt, heroImageCaption from post.data"
      pattern: "heroImageAlt.*heroImageCaption"
---

<objective>
Add hero image alt text and optional caption support to blog posts.

Purpose: Improve accessibility (proper alt text), enable editorial captions on hero images, and ensure semantic HTML structure using figure/figcaption.

Output: Updated schema with heroImageAlt and heroImageCaption optional fields, PostDetails.astro rendering hero images with proper alt text and conditional captions.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-image-caption-support/18-RESEARCH.md
@src/content.config.ts
@src/layouts/PostDetails.astro
@src/styles/typography.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heroImageAlt and heroImageCaption to schema</name>
  <files>src/content.config.ts</files>
  <action>
Add two new optional string fields to the blog collection schema in content.config.ts:

1. Add after the existing `heroImage: z.string().optional()` line (around line 20):
   ```typescript
   heroImageAlt: z.string().optional(),
   heroImageCaption: z.string().optional(),
   ```

2. Place them logically grouped with heroImage for maintainability.

These must be `.optional()` to maintain backward compatibility with existing posts that don't have these fields.
  </action>
  <verify>
Run `npm run build` - should complete without errors. Existing posts must not fail schema validation.
  </verify>
  <done>
content.config.ts contains heroImageAlt and heroImageCaption fields with z.string().optional() type, build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PostDetails.astro hero image rendering</name>
  <files>src/layouts/PostDetails.astro</files>
  <action>
Update PostDetails.astro to use semantic figure/figcaption and proper alt text:

1. **Add new props to destructuring** (around line 38, after heroImage):
   ```typescript
   heroImageAlt,
   heroImageCaption,
   ```

2. **Replace the hero image block** (lines 141-149) with figure-wrapped version:
   ```astro
   {heroImage && (
     <figure class="mb-8">
       <img
         src={heroImage}
         alt={heroImageAlt || title}
         class="aspect-video w-full rounded-md object-cover"
         loading="lazy"
       />
       {heroImageCaption && (
         <figcaption class="mt-2 text-center text-sm">
           {heroImageCaption}
         </figcaption>
       )}
     </figure>
   )}
   ```

Key points:
- Use `heroImageAlt || title` for alt text (title is fallback for accessibility)
- Wrap in `<figure>` for semantic HTML
- Keep existing classes on img (aspect-video, w-full, rounded-md, object-cover)
- Move mb-8 to figure (not img) to maintain spacing
- Conditional figcaption only renders when heroImageCaption exists
- figcaption styling: mt-2 (spacing from image), text-center, text-sm
  </action>
  <verify>
1. Run `npm run build` - passes
2. Run `npm run dev` and check:
   - Existing posts render hero images correctly (no visual regression)
   - View page source shows `<figure>` wrapper and alt text equals title
   - Inline `<figure><figcaption>` in markdown body renders with prose-figcaption styling (verify typography.css applies)
  </verify>
  <done>
PostDetails.astro uses figure/figcaption for hero images with alt text fallback to title, conditional caption rendering works, and the layout remains visually consistent with existing posts.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Schema validation:** `npm run build` passes with no content errors
2. **Backward compatibility:** Existing posts without heroImageAlt/heroImageCaption render correctly
3. **Alt text:** Hero images have meaningful alt attribute (check page source or browser devtools)
4. **Semantic HTML:** Hero image wrapped in `<figure>` element
5. **Inline figcaption:** Create test markdown with `<figure><figcaption>Test</figcaption></figure>` and verify prose-figcaption styling applies (text-foreground, 70% opacity)

Requirements covered:
- HERO-01: Alt text from heroImageAlt (fallback to title)
- HERO-02: Optional caption via figcaption
- HERO-03: heroImageAlt field in schema
- HERO-04: heroImageCaption field in schema
- IMG-01: Inline figure/figcaption uses prose-figcaption styling (already configured in typography.css)
</verification>

<success_criteria>
- [ ] heroImageAlt and heroImageCaption fields exist in content.config.ts schema
- [ ] PostDetails.astro destructures heroImageAlt and heroImageCaption from post.data
- [ ] Hero image wrapped in `<figure>` element
- [ ] img alt attribute uses `heroImageAlt || title`
- [ ] figcaption conditionally rendered when heroImageCaption exists
- [ ] `npm run build` passes
- [ ] Existing posts render without visual regression
</success_criteria>

<output>
After completion, create `.planning/phases/18-image-caption-support/18-01-SUMMARY.md`
</output>
