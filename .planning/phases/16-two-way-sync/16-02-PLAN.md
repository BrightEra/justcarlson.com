---
phase: 16-two-way-sync
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - scripts/publish.sh
autonomous: true

must_haves:
  truths:
    - "Running just publish sets draft: false in the Obsidian source file"
    - "Running just publish sets pubDatetime in the Obsidian source file"
    - "Author field in published posts uses value from settings.local.json when configured"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Two-way sync on publish"
      contains: "update_obsidian_source"
  key_links:
    - from: "scripts/publish.sh"
      to: "scripts/lib/common.sh"
      via: "update_obsidian_source call after copy_post"
      pattern: "update_obsidian_source.*publish"
    - from: "scripts/publish.sh"
      to: ".claude/settings.local.json"
      via: "get_author_from_config in normalize_frontmatter"
      pattern: "get_author_from_config"
---

<objective>
Extend publish.sh to sync metadata back to Obsidian source files and use config-driven author

Purpose: When publishing, set draft: false and pubDatetime in the original Obsidian file so it stays in sync
Output: publish.sh that updates Obsidian source after successful copy and uses author from config
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-two-way-sync/16-RESEARCH.md
@.planning/phases/16-two-way-sync/16-01-SUMMARY.md
@scripts/publish.sh
@scripts/lib/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update normalize_frontmatter to use config author</name>
  <files>scripts/publish.sh</files>
  <action>
Modify the `normalize_frontmatter()` function in publish.sh to use config-driven author instead of hardcoded "Justin Carlson".

Current code (around line 268):
```bash
content=$(echo "$content" | perl -0777 -pe 's/^author:\s*\n\s*-\s*.*$/author: "Justin Carlson"/m')
```

Change to:
```bash
# Get author from config, fallback to site default
local author
author=$(get_author_from_config)
if [[ -z "$author" ]]; then
    author="Justin Carlson"  # Default from site config
fi

# Replace author array with config value
content=$(echo "$content" | perl -0777 -pe "s/^author:\s*\n\s*-\s*.*\$/author: \"$author\"/m")
```

This satisfies CONF-01: Author normalization uses config value (not hardcoded string)
  </action>
  <verify>
1. grep for hardcoded "Justin Carlson" - should only appear as fallback comment or default value
2. Test with config author: Add `"author": "Test Author"` to settings.local.json, run publish --dry-run, check output shows correct author transformation
  </verify>
  <done>normalize_frontmatter uses get_author_from_config() with fallback, no hardcoded author in transformation</done>
</task>

<task type="auto">
  <name>Task 2: Add Obsidian source sync after successful publish</name>
  <files>scripts/publish.sh</files>
  <action>
Add a call to `update_obsidian_source()` in the `process_posts()` function after each post is successfully copied.

In the `process_posts()` function, after the line `copy_post "$file" "$slug" "$year"` (around line 845), add the Obsidian source update:

```bash
        # Copy and transform post
        copy_post "$file" "$slug" "$year"

        # Update Obsidian source file with publication metadata (two-way sync)
        update_obsidian_source "$file" "publish" "$DRY_RUN"

        if [[ "$DRY_RUN" != "true" ]]; then
            echo -e "  ${GREEN}Published:${RESET} ${BLOG_DIR}/${year}/${slug}.md"
        fi
```

This satisfies:
- SYNC-02: publish sets pubDatetime at publish time
- SYNC-03: publish sets draft: false in Obsidian source file
- SYNC-04: Backup created before modifying Obsidian files (via update_obsidian_source)

The dry-run support is already handled by passing $DRY_RUN to update_obsidian_source().
  </action>
  <verify>
1. Create test post in vault with `draft: true` and no pubDatetime
2. Run `just publish --dry-run` - should show "Would update Obsidian source" with draft: false and pubDatetime
3. Full test (manual, on real post): Run `just publish` on a test post, verify Obsidian source file now has draft: false, pubDatetime set, and .bak file exists
  </verify>
  <done>publish.sh calls update_obsidian_source after copy_post, setting draft: false and pubDatetime in Obsidian source</done>
</task>

</tasks>

<verification>
1. grep for update_obsidian_source in publish.sh: `grep "update_obsidian_source" scripts/publish.sh`
2. grep for get_author_from_config in publish.sh: `grep "get_author_from_config" scripts/publish.sh`
3. Run `just publish --dry-run` to see the full flow including Obsidian source update message
4. Verify scripts still lint: `npm run lint` passes
</verification>

<success_criteria>
- normalize_frontmatter() reads author from settings.local.json via get_author_from_config()
- normalize_frontmatter() uses "Justin Carlson" only as fallback when no config value
- process_posts() calls update_obsidian_source() after copy_post()
- Dry-run mode shows what Obsidian source updates would happen without modifying files
- After real publish, Obsidian source has draft: false and pubDatetime set
- After real publish, .bak file exists next to Obsidian source
</success_criteria>

<output>
After completion, create `.planning/phases/16-two-way-sync/16-02-SUMMARY.md`
</output>
