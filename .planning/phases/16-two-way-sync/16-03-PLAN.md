---
phase: 16-two-way-sync
plan: 03
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - scripts/unpublish.sh
autonomous: true

must_haves:
  truths:
    - "Running just unpublish sets draft: true in the Obsidian source file"
    - "Running just unpublish --dry-run shows what would change without modifying files"
    - "A .bak file is created before Obsidian file modification"
  artifacts:
    - path: "scripts/unpublish.sh"
      provides: "Two-way sync on unpublish with dry-run support"
      contains: "update_obsidian_source"
  key_links:
    - from: "scripts/unpublish.sh"
      to: "scripts/lib/common.sh"
      via: "update_obsidian_source call after remove_post"
      pattern: "update_obsidian_source.*unpublish"
---

<objective>
Extend unpublish.sh with --dry-run flag and sync draft: true back to Obsidian source

Purpose: When unpublishing, set draft: true in the original Obsidian file so it stays in sync and won't be re-discovered
Output: unpublish.sh with --dry-run flag and Obsidian source update after blog removal
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-two-way-sync/16-RESEARCH.md
@.planning/phases/16-two-way-sync/16-01-SUMMARY.md
@scripts/unpublish.sh
@scripts/lib/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --dry-run flag support to unpublish.sh</name>
  <files>scripts/unpublish.sh</files>
  <action>
Add --dry-run flag support to unpublish.sh following the same pattern as publish.sh.

1. Add global variable at top (after FORCE_MODE):
```bash
DRY_RUN=false
```

2. Add case in parse_args() (before the --help case):
```bash
            --dry-run)
                DRY_RUN=true
                shift
                ;;
```

3. Update print_usage() to document the new flag:
```bash
    echo "  --dry-run     Preview what would be changed without modifying files"
```

4. Modify remove_post() to respect dry-run mode. Instead of actually removing, show what would happen:
```bash
remove_post() {
    local post_path="$1"
    local title

    title=$(extract_frontmatter_value "$post_path" "title")
    if [[ -z "$title" ]]; then
        title=$(basename "$post_path" .md)
    fi

    echo ""
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "  [DRY-RUN] Would remove: $post_path"
        echo -e "  [DRY-RUN] Would commit: docs(blog): unpublish $title"
    else
        echo -e "${CYAN}Removing post...${RESET}"
        git rm "$post_path" --quiet
        local commit_msg="docs(blog): unpublish $title"
        git commit -m "$commit_msg" --quiet
        echo -e "${GREEN}Post removed and committed${RESET}"
        echo ""
        echo -e "${CYAN}Commit:${RESET} $commit_msg"
    fi
}
```

5. Update confirm_removal() to skip confirmation in dry-run mode (similar to --force):
```bash
    # Skip prompt if --force or --dry-run
    if [[ "$FORCE_MODE" == "true" || "$DRY_RUN" == "true" ]]; then
        return 0
    fi
```

This satisfies SYNC-05: `just unpublish --dry-run` previews changes without modifying files
  </action>
  <verify>
1. Run `./scripts/unpublish.sh --help` - should show --dry-run option
2. Run `just unpublish some-published-post --dry-run` - should show what would be removed without actually removing
3. Verify post still exists after dry-run: file should still be in src/content/blog/
  </verify>
  <done>unpublish.sh accepts --dry-run flag, shows what would change without modifying any files</done>
</task>

<task type="auto">
  <name>Task 2: Add Obsidian source lookup and sync to unpublish.sh</name>
  <files>scripts/unpublish.sh</files>
  <action>
The challenge: unpublish.sh starts with a blog post path/slug, but needs to find the original Obsidian source file to update it.

Solution: Search the vault for a file with matching slug. Add a new function and integrate it into the flow.

1. Add find_obsidian_source() function (before the main() function):
```bash
find_obsidian_source() {
    # Find the Obsidian source file for a given slug
    # Searches vault for .md file that slugifies to the given slug
    local slug="$1"

    if [[ -z "$VAULT_PATH" ]]; then
        # Config not loaded, try to load it
        if [[ -f "$CONFIG_FILE" ]]; then
            VAULT_PATH=$(jq -r '.obsidianVaultPath // empty' "$CONFIG_FILE" 2>/dev/null)
        fi
    fi

    if [[ -z "$VAULT_PATH" || ! -d "$VAULT_PATH" ]]; then
        echo ""  # Return empty if vault not configured
        return
    fi

    # Search for matching file in vault
    local found_file=""
    while IFS= read -r -d '' file; do
        local filename
        local file_slug
        filename=$(basename "$file")
        file_slug=$(slugify "$filename")

        if [[ "$file_slug" == "$slug" ]]; then
            found_file="$file"
            break
        fi
    done < <(find "$VAULT_PATH" -name "*.md" -type f -print0 2>/dev/null)

    echo "$found_file"
}
```

2. Modify main() to call update_obsidian_source after remove_post. Between remove_post and display_next_steps:
```bash
    # Remove post and commit
    remove_post "$post_path"

    # Find and update Obsidian source file
    local slug
    slug=$(slugify "$(basename "$post_path")")
    local obsidian_source
    obsidian_source=$(find_obsidian_source "$slug")

    if [[ -n "$obsidian_source" ]]; then
        echo ""
        echo -e "${CYAN}Updating Obsidian source...${RESET}"
        update_obsidian_source "$obsidian_source" "unpublish" "$DRY_RUN"
    else
        echo ""
        echo -e "${YELLOW}Note: Could not find Obsidian source file to update${RESET}"
        echo -e "${YELLOW}Manually set draft: true in your vault to prevent re-publishing${RESET}"
    fi

    # Display next steps (only if not dry-run)
    if [[ "$DRY_RUN" != "true" ]]; then
        display_next_steps
    fi
```

3. Update display_next_steps() to remove the manual status update instruction (since we now do it automatically):
```bash
display_next_steps() {
    echo ""
    echo -e "${GREEN}Post removed from blog${RESET}"
    echo ""
    echo -e "${CYAN}Changes committed locally. Run 'git push' when ready.${RESET}"
    echo ""
}
```

This satisfies:
- SYNC-01: unpublish sets draft: true in Obsidian source file
- SYNC-04: Backup created before modifying Obsidian files (via update_obsidian_source)
  </action>
  <verify>
1. grep for update_obsidian_source in unpublish.sh: should find it
2. grep for find_obsidian_source in unpublish.sh: should find function definition and call
3. Run `just unpublish some-post --dry-run` - should show both blog removal and Obsidian source update
4. Full test (manual): unpublish a real post, verify Obsidian source has draft: true and .bak file exists
  </verify>
  <done>unpublish.sh finds Obsidian source file and calls update_obsidian_source to set draft: true</done>
</task>

</tasks>

<verification>
1. Run `./scripts/unpublish.sh --help` - shows --dry-run option documented
2. Run `just unpublish test-post --dry-run` (on existing post) - shows full dry-run output including Obsidian source update
3. Verify no files changed after dry-run: blog post still exists, no .bak in vault
4. Verify scripts still lint: `npm run lint` passes
</verification>

<success_criteria>
- unpublish.sh accepts --dry-run flag
- Dry-run mode shows what would be removed from blog
- Dry-run mode shows what Obsidian source updates would happen
- Dry-run mode does NOT modify any files (no git rm, no .bak file)
- Real unpublish finds Obsidian source file and sets draft: true
- Real unpublish creates .bak file before modifying Obsidian source
- Display hints no longer ask user to manually update status (now automatic)
</success_criteria>

<output>
After completion, create `.planning/phases/16-two-way-sync/16-03-SUMMARY.md`
</output>
