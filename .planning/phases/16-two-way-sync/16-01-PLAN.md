---
phase: 16-two-way-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/common.sh
autonomous: true

must_haves:
  truths:
    - "update_obsidian_source function exists and creates .bak backup before modification"
    - "get_author_from_config function reads author from settings.local.json"
    - "yq --front-matter=process is used for YAML modification"
  artifacts:
    - path: "scripts/lib/common.sh"
      provides: "update_obsidian_source and get_author_from_config functions"
      contains: "update_obsidian_source"
  key_links:
    - from: "scripts/lib/common.sh"
      to: ".claude/settings.local.json"
      via: "jq read in get_author_from_config"
      pattern: "jq.*author.*CONFIG_FILE"
---

<objective>
Add shared functions to common.sh for Obsidian source file updates and config-driven author lookup

Purpose: Foundation for two-way sync - both publish.sh and unpublish.sh will use these shared functions
Output: Two new functions in scripts/lib/common.sh: update_obsidian_source() and get_author_from_config()
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-two-way-sync/16-RESEARCH.md
@scripts/lib/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_author_from_config function</name>
  <files>scripts/lib/common.sh</files>
  <action>
Add a new function `get_author_from_config()` to common.sh that:
1. Reads the `author` field from settings.local.json using jq
2. Returns empty string if field not set or config file missing
3. Does NOT provide a fallback - caller decides fallback behavior

Place it after the existing `load_config()` function.

Implementation (from research):
```bash
get_author_from_config() {
    # Read author from settings.local.json
    # Returns configured author or empty string if not set
    if [[ ! -f "$CONFIG_FILE" ]]; then
        return
    fi
    jq -r '.author // empty' "$CONFIG_FILE" 2>/dev/null
}
```

Why no fallback in function: Different callers may want different fallbacks or error handling.
  </action>
  <verify>
Run: `source scripts/lib/common.sh && get_author_from_config` - should return empty string (author not in config yet)
Add author to config and test: `echo '{"obsidianVaultPath": "/tmp", "author": "Test Author"}' > /tmp/test-config.json && CONFIG_FILE=/tmp/test-config.json source scripts/lib/common.sh && get_author_from_config` - should return "Test Author"
  </verify>
  <done>get_author_from_config function exists and returns empty when author not configured, returns author value when configured</done>
</task>

<task type="auto">
  <name>Task 2: Add update_obsidian_source function</name>
  <files>scripts/lib/common.sh</files>
  <action>
Add a new function `update_obsidian_source()` to common.sh that:
1. Takes 3 args: obsidian_file path, action ("publish" or "unpublish"), dry_run ("true" or "false")
2. If file doesn't exist, prints warning and returns 1
3. Creates `.bak` backup before any modification (SYNC-04)
4. Uses `yq --front-matter=process -i` for YAML modification
5. For "publish" action: sets `draft: false` and `pubDatetime` to current ISO8601 timestamp
6. For "unpublish" action: sets `draft: true`
7. In dry-run mode: prints what would change without modifying anything

Use `_get_yq_cmd()` helper already in common.sh to get correct yq command (go-yq vs yq).
Use `date -Iseconds` for ISO8601 timestamp with timezone.

Implementation (from research):
```bash
update_obsidian_source() {
    # Update Obsidian source file with publication metadata
    # Args:
    #   $1: obsidian_file - Path to source file in vault
    #   $2: action - "publish" or "unpublish"
    #   $3: dry_run - "true" or "false" (optional, default false)
    local obsidian_file="$1"
    local action="$2"
    local dry_run="${3:-false}"

    if [[ ! -f "$obsidian_file" ]]; then
        echo -e "${YELLOW}Warning: Source file not found: $obsidian_file${RESET}" >&2
        return 1
    fi

    local yq_cmd
    yq_cmd=$(_get_yq_cmd)

    if [[ "$action" == "publish" ]]; then
        local datetime
        datetime=$(date -Iseconds)

        if [[ "$dry_run" == "true" ]]; then
            echo -e "  [DRY-RUN] Would update Obsidian source:"
            echo -e "    File: $obsidian_file"
            echo -e "    draft: false"
            echo -e "    pubDatetime: $datetime"
        else
            # Create backup (SYNC-04)
            cp "$obsidian_file" "${obsidian_file}.bak"
            echo -e "  ${CYAN}Backup:${RESET} ${obsidian_file}.bak"

            # Update frontmatter using yq
            export DATETIME="$datetime"
            "$yq_cmd" --front-matter=process -i \
                '.draft = false | .pubDatetime = strenv(DATETIME)' \
                "$obsidian_file"
            unset DATETIME

            echo -e "  ${GREEN}Updated source:${RESET} draft=false, pubDatetime=$datetime"
        fi

    elif [[ "$action" == "unpublish" ]]; then
        if [[ "$dry_run" == "true" ]]; then
            echo -e "  [DRY-RUN] Would update Obsidian source:"
            echo -e "    File: $obsidian_file"
            echo -e "    draft: true"
        else
            # Create backup (SYNC-04)
            cp "$obsidian_file" "${obsidian_file}.bak"
            echo -e "  ${CYAN}Backup:${RESET} ${obsidian_file}.bak"

            # Update frontmatter
            "$yq_cmd" --front-matter=process -i '.draft = true' "$obsidian_file"

            echo -e "  ${GREEN}Updated source:${RESET} draft=true"
        fi
    fi
}
```

Place this function after get_author_from_config() in the Utility Functions section.
  </action>
  <verify>
1. Check function exists: `grep -A5 "update_obsidian_source()" scripts/lib/common.sh`
2. Create test file: `echo -e "---\ntitle: Test\ndraft: true\n---\nContent" > /tmp/test-post.md`
3. Test dry-run: `source scripts/lib/common.sh && update_obsidian_source /tmp/test-post.md publish true` - should show dry-run output, no .bak file created
4. Test actual publish: `source scripts/lib/common.sh && update_obsidian_source /tmp/test-post.md publish false && cat /tmp/test-post.md` - should show draft: false, pubDatetime set, .bak file exists
5. Verify backup: `ls /tmp/test-post.md.bak` - should exist
  </verify>
  <done>update_obsidian_source function exists, creates .bak backup before modification, uses yq for frontmatter updates, supports dry-run mode</done>
</task>

</tasks>

<verification>
1. Both functions exist in common.sh: `grep -E "(get_author_from_config|update_obsidian_source)" scripts/lib/common.sh | wc -l` returns 2+
2. shellcheck passes: `shellcheck -x scripts/lib/common.sh` (if installed)
3. Scripts still source without error: `bash -c "source scripts/lib/common.sh && echo OK"`
</verification>

<success_criteria>
- get_author_from_config() reads author from settings.local.json, returns empty if not set
- update_obsidian_source() creates .bak backup before any modification
- update_obsidian_source() uses yq --front-matter=process -i for YAML changes
- update_obsidian_source() supports both "publish" and "unpublish" actions
- update_obsidian_source() supports dry-run mode that shows changes without modifying files
- Existing scripts (publish.sh, unpublish.sh, list-posts.sh) still work after changes
</success_criteria>

<output>
After completion, create `.planning/phases/16-two-way-sync/16-01-SUMMARY.md`
</output>
