---
phase: 16-two-way-sync
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/publish.sh
  - scripts/list-posts.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "publish.sh discovers posts with draft: false (not status: Published)"
    - "list-posts.sh discovers posts with draft: false (not status: Published)"
    - "User instructions reference draft field, not status field"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "discover_posts using draft: false"
      contains: "draft:\\s*false"
    - path: "scripts/list-posts.sh"
      provides: "discovery using draft: false"
      contains: "draft:\\s*false"
  key_links:
    - from: "discover_posts()"
      to: "Obsidian frontmatter"
      via: "yq or pattern matching for draft: false"
      pattern: "draft.*false"
---

<objective>
Fix post discovery to use `draft: false` instead of `status: Published`

Purpose: The two-way sync (Phase 16) writes `draft: false` to Obsidian files on publish, but discover_posts() still looks for `status: Published`. This mismatch prevents the sync from being testable. This gap closure aligns discovery with the new schema.

Output: publish.sh and list-posts.sh discover posts using `draft: false` pattern
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-two-way-sync/16-UAT.md

# Key files to modify
@scripts/publish.sh
@scripts/list-posts.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update publish.sh discovery and user instructions</name>
  <files>scripts/publish.sh</files>
  <action>
Modify discover_posts() function (around line 416-436) to discover posts with `draft: false` instead of `status: Published`:

1. Change the comment on line 420 from "status: - Published" to "draft: false"
2. Replace the perl regex pattern on line 427:
   - OLD: `status:\s*\n\s*-\s*[Pp]ublished`
   - NEW: `draft:\s*false`
   The new pattern matches `draft: false` (with optional whitespace around colon)

3. Update echo on line 436 from "Published status" to "draft: false"

4. Update user instructions (around line 1059-1064) when no posts found:
   - OLD: "set its status to 'Published' in Obsidian:"
   - NEW: "set draft: false in the frontmatter:"
   - Replace the status YAML example with:
     ```
     draft: false
     ```

WHY: The Phase 16 two-way sync writes `draft: false` to Obsidian on publish. Discovery must match what sync writes.
  </action>
  <verify>
Run `grep -n "status.*[Pp]ublished" scripts/publish.sh` - should return NO matches in discover_posts or user instructions.
Run `grep -n "draft.*false" scripts/publish.sh` - should show matches in discover_posts() and user instructions.
  </verify>
  <done>
discover_posts() searches for `draft: false` pattern.
User instructions tell users to set `draft: false`, not `status: Published`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update list-posts.sh discovery for consistency</name>
  <files>scripts/list-posts.sh</files>
  <action>
Modify the discovery logic (around line 159-177) to use `draft: false`:

1. Change comment on line 159 from "Published status" to "draft: false"

2. Replace the perl regex pattern on line 165:
   - OLD: `status:\s*\n\s*-\s*[Pp]ublished`
   - NEW: `draft:\s*false`

3. Update the "No posts found" message on line 171:
   - OLD: "No posts found with Published status."
   - NEW: "No posts found with draft: false."

4. Update the user instructions (lines 173-175):
   - OLD: "add to frontmatter: status: - Published"
   - NEW: "set in frontmatter: draft: false"

WHY: list-posts.sh and publish.sh must use consistent discovery logic.
  </action>
  <verify>
Run `grep -n "status.*[Pp]ublished" scripts/list-posts.sh` - should return NO matches in discovery section.
Run `grep -n "draft.*false" scripts/list-posts.sh` - should show matches in discovery and user instructions.
  </verify>
  <done>
list-posts.sh discovers posts using `draft: false` pattern.
User instructions reference `draft: false`, not `status: Published`.
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. Pattern verification:
   ```bash
   # No more status: Published patterns in discovery functions
   grep -n "status.*[Pp]ublished" scripts/publish.sh scripts/list-posts.sh
   # Should return empty or only comments
   ```

2. New pattern present:
   ```bash
   # draft: false pattern in both scripts
   grep -n "draft.*false" scripts/publish.sh scripts/list-posts.sh
   # Should show matches in discover_posts and user instructions
   ```

3. Functional test (if test post available):
   ```bash
   # Create test post with draft: false and verify discovery
   just publish --dry-run  # Should find posts with draft: false
   ```
</verification>

<success_criteria>
- publish.sh discover_posts() uses `draft: false` pattern
- list-posts.sh discovery uses `draft: false` pattern
- User instructions in both scripts reference `draft: false`
- No references to `status: Published` in discovery logic
</success_criteria>

<output>
After completion, create `.planning/phases/16-two-way-sync/16-04-SUMMARY.md`
</output>
