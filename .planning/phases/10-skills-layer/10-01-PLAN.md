---
phase: 10-skills-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/publish/SKILL.md
  - .claude/skills/install/SKILL.md
  - .claude/skills/maintain/SKILL.md
  - .claude/skills/list-posts/SKILL.md
  - .claude/skills/unpublish/SKILL.md
  - .claude/hooks/verify-build.sh
  - .claude/hooks/verify-install.sh
  - .claude/settings.json
autonomous: true

must_haves:
  truths:
    - "User can run /publish skill for human-in-the-loop publishing oversight"
    - "User can run /install skill for guided setup"
    - "User can run /maintain skill to see health report"
    - "User can run /list-posts skill to see post listing"
    - "User can run /unpublish skill to remove a post"
    - "Skills only trigger via manual invocation, never auto-triggered"
    - "Stop hooks block Claude from stopping until build passes"
  artifacts:
    - path: ".claude/skills/publish/SKILL.md"
      provides: "/publish skill wrapping just publish"
      contains: "disable-model-invocation: true"
    - path: ".claude/skills/install/SKILL.md"
      provides: "/install skill wrapping just setup"
      contains: "disable-model-invocation: true"
    - path: ".claude/skills/maintain/SKILL.md"
      provides: "/maintain skill for health checks"
      contains: "disable-model-invocation: true"
    - path: ".claude/skills/list-posts/SKILL.md"
      provides: "/list-posts skill wrapping just list-posts"
      contains: "disable-model-invocation: true"
    - path: ".claude/skills/unpublish/SKILL.md"
      provides: "/unpublish skill wrapping just unpublish"
      contains: "disable-model-invocation: true"
    - path: ".claude/hooks/verify-build.sh"
      provides: "Stop hook for build verification"
      contains: "npm run build"
    - path: ".claude/hooks/verify-install.sh"
      provides: "Stop hook for install verification"
      contains: "obsidianVaultPath"
    - path: ".claude/settings.json"
      provides: "Updated setup hook with config check"
      contains: "Setup"
  key_links:
    - from: ".claude/skills/publish/SKILL.md"
      to: ".claude/hooks/verify-build.sh"
      via: "Stop hook frontmatter"
      pattern: "verify-build.sh"
    - from: ".claude/skills/install/SKILL.md"
      to: ".claude/hooks/verify-install.sh"
      via: "Stop hook frontmatter"
      pattern: "verify-install.sh"
    - from: ".claude/skills/publish/SKILL.md"
      to: "justfile"
      via: "just publish command"
      pattern: "just publish"
---

<objective>
Create Claude Code skills layer with manual-invocation-only oversight for publishing workflows.

Purpose: Provide optional human-in-the-loop oversight wrapping existing justfile recipes without duplicating logic. Skills guide users through workflows while stop hooks enforce verification gates.

Output:
- 5 skill files in .claude/skills/
- 2 stop hook scripts in .claude/hooks/
- Updated settings.json with enhanced setup hook
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-skills-layer/10-CONTEXT.md
@.planning/phases/10-skills-layer/10-RESEARCH.md
@justfile
@.claude/settings.json
@.claude/hooks/git-safety.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all skill files</name>
  <files>
    .claude/skills/publish/SKILL.md
    .claude/skills/install/SKILL.md
    .claude/skills/maintain/SKILL.md
    .claude/skills/list-posts/SKILL.md
    .claude/skills/unpublish/SKILL.md
  </files>
  <action>
Create `.claude/skills/` directory structure with 5 skill files.

**All skills must have:**
- `disable-model-invocation: true` in frontmatter (CRITICAL - prevents auto-triggering)
- Clear description for `/help` display
- Instructions that wrap justfile recipes, NOT duplicate logic

**Skill 1: /publish** (`.claude/skills/publish/SKILL.md`)
```yaml
---
name: publish
description: Publish blog posts from Obsidian vault with human oversight
disable-model-invocation: true
hooks:
  Stop:
    - hooks:
        - type: command
          command: "$CLAUDE_PROJECT_DIR/.claude/hooks/verify-build.sh"
          timeout: 120
---
```
Body: Guide user through publishing with `just publish`. For each post, show frontmatter preview, ask for confirmation. Use `just publish --dry-run` first. Emphasize that stop hook ensures build passes before completion.

**Skill 2: /install** (`.claude/skills/install/SKILL.md`)
```yaml
---
name: install
description: Guide setup of Obsidian vault path, dependencies, and build verification
disable-model-invocation: true
hooks:
  Stop:
    - hooks:
        - type: command
          command: "$CLAUDE_PROJECT_DIR/.claude/hooks/verify-install.sh"
          timeout: 60
---
```
Body: Interactive Q&A setup guide. Steps: (1) Run `just setup` for vault path, (2) Verify npm packages with `npm list`, (3) Test build with `npm run build`. Stop hook verifies all checks pass.

**Skill 3: /maintain** (`.claude/skills/maintain/SKILL.md`)
```yaml
---
name: maintain
description: Check for outdated dependencies, lint issues, and content validation
disable-model-invocation: true
---
```
Body: Report-only health checks. Run: `npm outdated`, `npm run lint`, `npm run build`, `just list-posts --all`. Present findings in sections (Critical, Warning, Info). NO auto-fixing - user decides what to address.

**Skill 4: /list-posts** (`.claude/skills/list-posts/SKILL.md`)
```yaml
---
name: list-posts
description: List blog posts from Obsidian vault with validation status
disable-model-invocation: true
---
```
Body: Minimal oversight. Run `just list-posts` (default: unpublished) or with flags (`--all`, `--published`). Present output clearly. No confirmation needed - read-only operation.

**Skill 5: /unpublish** (`.claude/skills/unpublish/SKILL.md`)
```yaml
---
name: unpublish
description: Remove a post from blog repo (keeps Obsidian source)
disable-model-invocation: true
---
```
Body: Confirm before removing. Use `$ARGUMENTS` for file parameter. Run `just unpublish "$ARGUMENTS"`. Remind user to update Obsidian status to prevent re-publishing. Note: commits but does NOT push.
  </action>
  <verify>
Verify all 5 skill files exist and have correct structure:
```bash
for skill in publish install maintain list-posts unpublish; do
  test -f ".claude/skills/$skill/SKILL.md" && \
  grep -q "disable-model-invocation: true" ".claude/skills/$skill/SKILL.md" && \
  echo "$skill: OK" || echo "$skill: MISSING or INVALID"
done
```
  </verify>
  <done>
All 5 skill files exist in .claude/skills/ with disable-model-invocation: true and appropriate content wrapping justfile recipes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stop hooks and update settings.json</name>
  <files>
    .claude/hooks/verify-build.sh
    .claude/hooks/verify-install.sh
    .claude/settings.json
  </files>
  <action>
**Stop Hook 1: verify-build.sh** (`.claude/hooks/verify-build.sh`)

Create bash script following git-safety.sh pattern:
```bash
#!/usr/bin/env bash
# Stop hook for /publish skill - verifies build passes before Claude stops
set -euo pipefail

INPUT=$(cat)

# Prevent infinite loop - check stop_hook_active
STOP_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false')
if [[ "$STOP_ACTIVE" == "true" ]]; then
    exit 0
fi

# Run build
echo "Verifying build passes..." >&2
if ! npm run build 2>&1 | tee /tmp/build-verify.log; then
    echo "" >&2
    echo "BUILD FAILED - Fix errors before stopping:" >&2
    tail -20 /tmp/build-verify.log >&2
    exit 2  # Block stop
fi

echo "Build verified successfully." >&2
exit 0
```
Make executable with `chmod +x`.

**Stop Hook 2: verify-install.sh** (`.claude/hooks/verify-install.sh`)

Create bash script:
```bash
#!/usr/bin/env bash
# Stop hook for /install skill - verifies setup is complete
set -euo pipefail

INPUT=$(cat)
CONFIG_FILE=".claude/settings.local.json"

# Prevent infinite loop
STOP_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false')
if [[ "$STOP_ACTIVE" == "true" ]]; then
    exit 0
fi

FAILED=0

# Check 1: Vault path configured
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "MISSING: Config file $CONFIG_FILE" >&2
    FAILED=1
elif ! jq -e '.obsidianVaultPath' "$CONFIG_FILE" >/dev/null 2>&1; then
    echo "MISSING: obsidianVaultPath in config" >&2
    FAILED=1
else
    echo "OK: Vault path configured" >&2
fi

# Check 2: Dependencies installed
if [[ ! -d "node_modules" ]]; then
    echo "MISSING: node_modules (run npm install)" >&2
    FAILED=1
else
    echo "OK: Dependencies installed" >&2
fi

# Check 3: Build passes
echo "Checking build..." >&2
if ! npm run build 2>&1 | tee /tmp/install-verify.log; then
    echo "FAILED: Build has errors" >&2
    FAILED=1
else
    echo "OK: Build passes" >&2
fi

if [[ "$FAILED" -eq 1 ]]; then
    echo "" >&2
    echo "Setup incomplete - fix issues above before stopping" >&2
    exit 2
fi

echo "Setup verified successfully." >&2
exit 0
```
Make executable.

**Update settings.json:**

Read existing .claude/settings.json and modify the Setup hook to:
1. Keep existing "init" matcher for setup.sh
2. Add new "startup" matcher that checks config and suggests /install

The updated Setup section should be:
```json
{
  "hooks": {
    "Setup": [
      {
        "matcher": "init",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/scripts/setup.sh"
          }
        ]
      },
      {
        "matcher": "startup",
        "hooks": [
          {
            "type": "command",
            "command": "test -f \"$CLAUDE_PROJECT_DIR/.claude/settings.local.json\" && jq -e '.obsidianVaultPath' \"$CLAUDE_PROJECT_DIR/.claude/settings.local.json\" >/dev/null 2>&1 || echo 'Vault not configured. Run /install for guided setup.'"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/git-safety.sh"
          }
        ]
      }
    ]
  }
}
```

This keeps the init hook (for `claude --init`) and adds a startup hook that runs on every session start, checking if vault is configured and suggesting /install if not.
  </action>
  <verify>
```bash
# Verify stop hooks exist and are executable
test -x ".claude/hooks/verify-build.sh" && echo "verify-build.sh: OK" || echo "verify-build.sh: MISSING or NOT EXECUTABLE"
test -x ".claude/hooks/verify-install.sh" && echo "verify-install.sh: OK" || echo "verify-install.sh: MISSING or NOT EXECUTABLE"

# Verify settings.json has both Setup matchers
jq -e '.hooks.Setup | length == 2' .claude/settings.json && echo "settings.json Setup hooks: OK" || echo "settings.json: MISSING startup hook"

# Verify stop hooks check stop_hook_active
grep -q "stop_hook_active" ".claude/hooks/verify-build.sh" && echo "verify-build.sh loop prevention: OK" || echo "verify-build.sh: MISSING loop prevention"
grep -q "stop_hook_active" ".claude/hooks/verify-install.sh" && echo "verify-install.sh loop prevention: OK" || echo "verify-install.sh: MISSING loop prevention"
```
  </verify>
  <done>
Two stop hooks exist in .claude/hooks/, are executable, include stop_hook_active check to prevent infinite loops. settings.json has both init and startup matchers in Setup hooks section.
  </done>
</task>

</tasks>

<verification>
**Skills work as expected:**
1. All 5 skills appear in Claude's skill list (check with `/help` or skills listing)
2. Skills have `disable-model-invocation: true` (grep verification)
3. Stop hooks are executable and include infinite loop prevention

**Integration test:**
- `/publish` wraps `just publish`, stop hook blocks if build fails
- `/install` wraps `just setup`, stop hook blocks if setup incomplete
- `/maintain` runs checks and reports without auto-fixing
- `/list-posts` runs `just list-posts` with optional flags
- `/unpublish` confirms before running `just unpublish`

**Settings verification:**
- Setup hook still triggers on `claude --init`
- Startup hook runs on every session, suggests `/install` if vault not configured
</verification>

<success_criteria>
- [ ] All 5 skill files exist in .claude/skills/*/SKILL.md
- [ ] All skills have disable-model-invocation: true
- [ ] /publish and /install have Stop hook frontmatter referencing verify scripts
- [ ] verify-build.sh and verify-install.sh exist and are executable
- [ ] Both stop hooks check stop_hook_active to prevent infinite loops
- [ ] settings.json has both init and startup Setup hooks
- [ ] All skills wrap justfile recipes (no duplicated bash logic)
</success_criteria>

<output>
After completion, create `.planning/phases/10-skills-layer/10-01-SUMMARY.md`
</output>
