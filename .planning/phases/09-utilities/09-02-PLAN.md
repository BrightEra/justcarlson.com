---
phase: 09-utilities
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - scripts/unpublish.sh
  - justfile
  - .claude/hooks/unpublish.post.md
autonomous: true

must_haves:
  truths:
    - "User can run `just unpublish <file>` to remove a post from blog"
    - "Unpublish shows confirmation prompt before removal"
    - "User can skip confirmation with `--force` flag"
    - "Unpublish commits removal but does NOT push"
    - "After unpublish, user sees tip to update Obsidian status"
    - "Images are left in repo (not removed)"
    - "Obsidian source file is untouched"
  artifacts:
    - path: "scripts/unpublish.sh"
      provides: "Post removal with confirmation and git commit"
      contains: "unpublish"
    - path: "justfile"
      provides: "unpublish recipe with file and force args"
      contains: "unpublish"
    - path: ".claude/hooks/unpublish.post.md"
      provides: "Post-unpublish hook prompting to push"
      contains: "Update status in Obsidian"
  key_links:
    - from: "justfile"
      to: "scripts/unpublish.sh"
      via: "recipe invocation"
      pattern: "./scripts/unpublish.sh"
    - from: "scripts/unpublish.sh"
      to: "git rm"
      via: "file removal"
      pattern: "git rm"
    - from: "scripts/unpublish.sh"
      to: "git commit"
      via: "commit creation"
      pattern: 'git commit -m'
---

<objective>
Create the `just unpublish` command that removes a published post from the blog repository.

Purpose: Allow quick post removal without manually deleting files and creating commits. The post remains in Obsidian for potential future republishing.

Output: scripts/unpublish.sh script, justfile recipe, and post-unpublish hook that prompts about pushing.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-utilities/09-CONTEXT.md
@.planning/phases/09-utilities/09-RESEARCH.md
@scripts/publish.sh
@scripts/list-posts.sh
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unpublish.sh script</name>
  <files>scripts/unpublish.sh</files>
  <action>
Create a new bash script that removes a published post from the blog repository.

**Arguments:**
- `$1`: File path or slug of post to unpublish (required)
- `--force` or `-f`: Skip confirmation prompt

**Flow:**
1. Parse arguments (extract file/slug and check for --force)
2. Load config using same pattern as publish.sh
3. Resolve post location:
   - If input is a path, extract slug from filename
   - Search for post in blog directory: `src/content/blog/*/slug.md`
   - Error if post not found in blog repo
4. Display post info for confirmation:
   ```
   Remove from blog: "Post Title"
     Path: src/content/blog/2026/my-post.md
   ```
5. Unless --force: prompt for confirmation `[y/N]` (default No for safety)
6. Execute removal:
   - `git rm <blog-path>` (only the markdown file, NOT images)
   - `git commit -m "docs(blog): unpublish <title>"`
7. Do NOT push (per CONTEXT.md decision)
8. Display success message with tip:
   ```
   Post removed from blog

   Note: Update status in Obsidian to prevent re-publishing:
     status:
       - Draft  (or remove - Published)

   Changes committed locally. Run 'git push' when ready.
   ```

**Key patterns to reuse from publish.sh:**
- Colors: RED, GREEN, YELLOW, CYAN, RESET (lines 6-10)
- Config loading: load_config() pattern (lines 394-422)
- Frontmatter extraction: extract_frontmatter_value() (lines 446-453)
- Slugify: slugify() function (lines 428-444)

**File resolution logic:**
1. If arg contains `/` or ends in `.md`, treat as path and extract basename
2. Slugify the basename (remove .md, lowercase, etc.)
3. Search `src/content/blog/*/slug.md` using glob
4. If multiple matches (shouldn't happen), use first one

**Why NOT remove images (from CONTEXT.md):**
- Safer: avoids orphan image complexity
- Images may be shared across posts
- Blog images are small; cleanup can be separate if needed

**Exit codes:**
- 0: Success (post removed and committed)
- 1: Error (post not found, git operation failed)
- 130: Cancelled by user (at confirmation prompt)
  </action>
  <verify>
Run `./scripts/unpublish.sh --help` (if implemented) or `./scripts/unpublish.sh test-slug` - should either show help or error about post not found.
Verify script is executable: `ls -la scripts/unpublish.sh`
  </verify>
  <done>
Script exists, is executable, and handles file resolution, confirmation, and git operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire unpublish recipe and create post-hook</name>
  <files>justfile, .claude/hooks/unpublish.post.md</files>
  <action>
**Part A: Add unpublish recipe to justfile**

Add the unpublish recipe to the "=== Utilities ===" section (created in Plan 01):

```just
# Remove a post from blog repo (keeps Obsidian source)
unpublish file *args='':
    ./scripts/unpublish.sh {{file}} {{args}}
```

**Placement:** After `list-posts` recipe in Utilities section.

**Why `file` is positional:** User runs `just unpublish my-post.md` or `just unpublish my-post.md --force`.

---

**Part B: Create post-unpublish hook**

Create `.claude/hooks/unpublish.post.md`:

```markdown
---
name: unpublish.post
description: Prompts after unpublish to push changes and update Obsidian
match_commands: ["just unpublish"]
---

# Post-Unpublish Hook

After `just unpublish` completes, prompt the user:

1. **Ask about pushing:**
   "Push the removal to remote? [Y/n]"
   - If Yes: run `git push`
   - If No: skip push (changes remain local)

2. **Remind about Obsidian:**
   Display: "Remember to update the post status in Obsidian to prevent re-publishing."

## Important

- This hook runs AFTER unpublish completes
- Only prompt about push - never re-run unpublish
- If user declines push, that's fine - they can push later
- Exit code 0 regardless of push decision
```

**Hook pattern matches existing hooks in .claude/hooks/ directory.**
  </action>
  <verify>
Run `just --list` - should show `unpublish` recipe.
Check hook exists: `ls -la .claude/hooks/unpublish.post.md`
Test recipe with non-existent post: `just unpublish fake-post` - should error gracefully.
  </verify>
  <done>
- `just unpublish <file>` works with confirmation
- `just unpublish <file> --force` skips confirmation
- Post-unpublish hook file exists with correct content
- Unpublish commits but does not push
  </done>
</task>

</tasks>

<verification>
1. `just unpublish <slug>` prompts for confirmation, removes post, commits, doesn't push
2. `just unpublish <slug> --force` skips confirmation
3. Trying to unpublish non-existent post shows clear error
4. Git log shows conventional commit message: `docs(blog): unpublish <title>`
5. Images in `public/assets/blog/<slug>/` are NOT removed
6. Post-unpublish hook file exists at `.claude/hooks/unpublish.post.md`
</verification>

<success_criteria>
- scripts/unpublish.sh exists and is executable
- justfile contains unpublish recipe with file and args passthrough
- .claude/hooks/unpublish.post.md exists with correct hook definition
- Confirmation prompt works (default No for safety)
- --force flag skips confirmation
- Git operations: rm + commit, no push
- Clear tip displayed about Obsidian status
</success_criteria>

<output>
After completion, create `.planning/phases/09-utilities/09-02-SUMMARY.md`
</output>
