---
phase: 19-justfile-hero-image-support
plan: 02
type: execute
wave: 1
depends_on: ["01"]
files_modified: [scripts/publish.sh]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "heroImage field preserved when post has hero image value"
    - "Empty heroImage/heroImageAlt/heroImageCaption fields stripped correctly"
    - "Build succeeds after publishing post with hero image"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Correct perl regex pattern in normalize_frontmatter()"
      contains: "perl -pe 's/^heroImage:[ \\t]*\\n//m'"
  key_links:
    - from: "scripts/publish.sh"
      to: "perl regex engine"
      via: "explicit whitespace class [ \\t]"
      pattern: "[ \\t]*\\n"
---

<objective>
Fix Perl variable interpolation bug in publish.sh normalize_frontmatter() that strips heroImage key from frontmatter.

Purpose: UAT revealed that the regex pattern `\s*$\n?` is broken because Perl interprets `$\n` as the variable `$\` (output record separator) followed by literal 'n', not as end-of-line anchor + newline. The compiled regex becomes `\s*n?` which matches and strips the heroImage KEY even when a value is present.

Output: publish.sh with correct regex patterns that only match truly empty fields (key followed by whitespace and newline, no value).
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/19-justfile-hero-image-support/19-UAT.md

# The bug is in normalize_frontmatter() function
@scripts/publish.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix perl regex pattern in normalize_frontmatter()</name>
  <files>scripts/publish.sh</files>
  <action>
In the normalize_frontmatter() function, change the three perl regex patterns from `\s*$\n?` to `[ \t]*\n`:

Line 278 (heroImage):
Before: content=$(echo "$content" | perl -pe 's/^heroImage:\s*$\n?//m')
After:  content=$(echo "$content" | perl -pe 's/^heroImage:[ \t]*\n//m')

Line 281 (heroImageAlt):
Before: content=$(echo "$content" | perl -pe 's/^heroImageAlt:\s*$\n?//m')
After:  content=$(echo "$content" | perl -pe 's/^heroImageAlt:[ \t]*\n//m')

Line 284 (heroImageCaption):
Before: content=$(echo "$content" | perl -pe 's/^heroImageCaption:\s*$\n?//m')
After:  content=$(echo "$content" | perl -pe 's/^heroImageCaption:[ \t]*\n//m')

The key changes:
1. `\s*` → `[ \t]*` - Use explicit space/tab class instead of `\s` (which includes newlines)
2. `$\n?` → `\n` - Remove the problematic `$` anchor (Perl interprets `$\n` as variable), use required newline

Why this works:
- Pattern `[ \t]*\n` matches: zero or more spaces/tabs, followed by newline
- This ONLY matches empty fields: `heroImage:\n` or `heroImage:   \n`
- Does NOT match fields with values: `heroImage: foo.jpg\n` (has content before newline)
- The original `$` anchor was broken by Perl variable interpolation anyway
  </action>
  <verify>
1. Check the fix is applied:
   grep -n "perl -pe" scripts/publish.sh | grep -E "heroImage|heroImageAlt|heroImageCaption"
   Should show `[ \t]*\n` pattern on all three lines

2. Test value preservation (CRITICAL):
   echo -e "heroImage: test.jpg\ntitle: Test" | perl -pe 's/^heroImage:[ \t]*\n//m'
   Should output UNCHANGED: "heroImage: test.jpg" and "title: Test"

3. Test empty field removal:
   echo -e "heroImage:\ntitle: Test" | perl -pe 's/^heroImage:[ \t]*\n//m'
   Should output only: "title: Test"

4. Test whitespace-only field removal:
   echo -e "heroImage:   \ntitle: Test" | perl -pe 's/^heroImage:[ \t]*\n//m'
   Should output only: "title: Test"
  </verify>
  <done>
- perl regex patterns use `[ \t]*\n` instead of `\s*$\n?`
- Posts with heroImage values preserve the field
- Posts with empty/whitespace-only heroImage have the field stripped
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify fix with actual publish</name>
  <files>scripts/publish.sh</files>
  <action>
Test the fix by re-running the publish workflow on the Hello World post that previously failed:

1. Check that Hello World.md still has heroImage in source:
   grep "heroImage" "/home/jc/notes/personal-vault/Hello World.md"

2. Run publish workflow:
   ./scripts/publish.sh
   Select Hello World when prompted

3. Verify build succeeds without YAML parse errors

4. Check the published file has heroImage preserved:
   grep "heroImage" src/content/blog/2026/hello-world.md
  </action>
  <verify>
Build completes successfully and `grep heroImage src/content/blog/2026/hello-world.md` shows the heroImage field with its value intact.
  </verify>
  <done>
- Publish workflow completes without YAML parse errors
- heroImage field values are preserved in published frontmatter
- Build verification passes
  </done>
</task>

</tasks>

<verification>
1. Regex pattern: `grep "perl -pe" scripts/publish.sh` shows `[ \t]*\n` pattern
2. Unit test value preservation: `echo -e "heroImage: foo.jpg\n" | perl -pe 's/^heroImage:[ \t]*\n//m'` outputs unchanged
3. Unit test empty removal: `echo -e "heroImage:\n" | perl -pe 's/^heroImage:[ \t]*\n//m'` outputs empty
4. Integration: publish Hello World post with heroImage succeeds
</verification>

<success_criteria>
- [ ] Lines 278, 281, 284 use `[ \t]*\n` pattern instead of `\s*$\n?`
- [ ] Posts with heroImage values build successfully
- [ ] Empty heroImage/heroImageAlt/heroImageCaption fields are stripped
- [ ] Hello World post publishes successfully with hero image
</success_criteria>

<output>
After completion, create `.planning/phases/19-justfile-hero-image-support/19-02-SUMMARY.md`
</output>
