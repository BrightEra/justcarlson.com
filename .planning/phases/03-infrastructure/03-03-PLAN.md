---
phase: 03-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/integrations/build-validator.ts
  - astro.config.mjs
  - src/pages/404.astro
autonomous: true

must_haves:
  truths:
    - "Build runs identity leak detection at build time"
    - "Identity leaks produce warnings (not failures)"
    - "404 page shows justcarlson.com branding"
    - "Production build succeeds with no broken references"
  artifacts:
    - path: "src/integrations/build-validator.ts"
      provides: "Build-time validation integration"
      exports: ["default"]
    - path: "src/pages/404.astro"
      provides: "Custom 404 page"
      contains: "SITE.title"
  key_links:
    - from: "astro.config.mjs"
      to: "src/integrations/build-validator.ts"
      via: "integration import"
      pattern: "buildValidator"
---

<objective>
Add build-time validation for identity leaks and fix the 404 page branding.

Purpose: Catch residual identity leaks at build time with warnings (not failures), and ensure the 404 page shows Just Carlson branding instead of "Peter Steinberger's blog".

Output: Build validation integration, updated 404 page, and verified production build.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-infrastructure/03-RESEARCH.md

Current state:
- src/pages/404.astro line 9 has "Peter Steinberger's blog" in description
- No build validation exists for identity leaks
- Decisions from CONTEXT.md: identity leak detection should WARN only, not fail
- TypeScript/lint errors should continue to fail build (existing behavior)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build validation integration</name>
  <files>src/integrations/build-validator.ts</files>
  <action>
Create a new Astro integration at src/integrations/build-validator.ts that runs identity leak detection at build time.

The integration should:
1. Use the astro:build:done hook
2. Run grep to search for "steipete" or "Peter Steinberger" (case-insensitive) in dist/
3. Log warnings (logger.warn) if leaks found - do NOT throw or fail the build
4. Log success (logger.info) if no leaks found
5. Optionally verify critical pages exist (/, /about, /posts) - warn only if missing

Key implementation notes:
- Use execSync with `|| true` to prevent grep exit code 1 (no matches) from throwing
- Set maxBuffer to handle large output
- Use logger.warn for warnings, logger.info for success
- Do NOT use logger.error or throw - this is warn-only per requirements

Template from research:
```typescript
import type { AstroIntegration } from 'astro';
import { execSync } from 'child_process';

export default function buildValidator(): AstroIntegration {
  return {
    name: 'build-validator',
    hooks: {
      'astro:build:done': async ({ dir, pages, logger }) => {
        // Identity leak detection
        // Critical page verification
      }
    }
  };
}
```
  </action>
  <verify>test -f src/integrations/build-validator.ts && grep "astro:build:done" src/integrations/build-validator.ts</verify>
  <done>Build validation integration created with identity leak detection</done>
</task>

<task type="auto">
  <name>Task 2: Register integration in astro.config.mjs</name>
  <files>astro.config.mjs</files>
  <action>
Add the build-validator integration to astro.config.mjs:

1. Add import at top (after other integrations):
   ```javascript
   import buildValidator from "./src/integrations/build-validator.ts";
   ```

2. Add to integrations array (after AstroPWA):
   ```javascript
   integrations: [
     mdx(),
     sitemap({ ... }),
     react(),
     AstroPWA({ ... }),
     buildValidator(),  // Add this line
   ],
   ```

The integration should be last since it validates the build output.
  </action>
  <verify>grep "buildValidator" astro.config.mjs && grep "build-validator" astro.config.mjs</verify>
  <done>Build validator integration registered in Astro config</done>
</task>

<task type="auto">
  <name>Task 3: Fix 404 page description</name>
  <files>src/pages/404.astro</files>
  <action>
Update the 404 page description on line 9 to remove Peter's name.

Change from:
```astro
<Layout title={`404 Not Found | ${SITE.title}`} description="Page not found. The requested page doesn't exist on Peter Steinberger's blog.">
```

To:
```astro
<Layout title={`404 Not Found | ${SITE.title}`} description="Page not found. The requested page doesn't exist.">
```

This makes the description generic and uses SITE.title (which is "Just Carlson") for the title part.
  </action>
  <verify>grep -v "Peter Steinberger" src/pages/404.astro | grep "404" && echo "No Peter reference in 404.astro"</verify>
  <done>404 page shows generic description without Peter's name</done>
</task>

</tasks>

<verification>
1. Run `npm run build` and verify:
   - Build completes successfully
   - Identity leak warnings appear if any leaks exist
   - No TypeScript errors from new integration
2. Check 404.astro has no Peter Steinberger references: `grep -i "peter\|steipete" src/pages/404.astro`
3. Verify integration registered: `grep "buildValidator" astro.config.mjs`
</verification>

<success_criteria>
- Build completes with validation integration active
- Identity leak detection runs at build time (visible in build output)
- 404 page description is generic (no Peter Steinberger reference)
- Build does not fail due to validation warnings
- All TypeScript checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-infrastructure/03-03-SUMMARY.md`
</output>
