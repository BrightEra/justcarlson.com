---
phase: 15-library-extraction-yq-integration
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - scripts/lib/common.sh
  - scripts/publish.sh
  - scripts/unpublish.sh
  - scripts/list-posts.sh
  - scripts/setup.sh
  - scripts/bootstrap.sh
autonomous: true

must_haves:
  truths:
    - "All scripts source common.sh and use its constants/functions"
    - "No duplicate color constants remain in individual scripts"
    - "No duplicate validation or utility functions remain in individual scripts"
    - "shellcheck passes on all scripts"
    - "yq extracts frontmatter correctly from test files"
  artifacts:
    - path: "scripts/lib/common.sh"
      provides: "Validation functions (extract_frontmatter, get_frontmatter_field, validate_iso8601, validate_frontmatter)"
      contains: "validate_frontmatter()"
    - path: "scripts/lib/common.sh"
      provides: "Utility functions (slugify, load_config, extract_frontmatter_value)"
      contains: "slugify()"
    - path: "scripts/publish.sh"
      provides: "Publishing script sourcing common.sh"
      contains: "source.*lib/common.sh"
    - path: "scripts/unpublish.sh"
      provides: "Unpublishing script sourcing common.sh"
      contains: "source.*lib/common.sh"
    - path: "scripts/list-posts.sh"
      provides: "List posts script sourcing common.sh"
      contains: "source.*lib/common.sh"
  key_links:
    - from: "scripts/publish.sh"
      to: "scripts/lib/common.sh"
      via: "BASH_SOURCE source pattern"
      pattern: 'SCRIPT_DIR.*BASH_SOURCE'
    - from: "scripts/lib/common.sh"
      to: "yq command"
      via: "frontmatter extraction"
      pattern: "yq.*--front-matter"
---

<objective>
Extract all duplicated functions to common.sh, migrate frontmatter parsing from sed/grep to yq, and update all 5 scripts to source the shared library.

Purpose: Eliminate ~280 lines of duplicated code across scripts. Replace fragile sed/grep YAML parsing with yq which correctly handles quoted values, multiline fields, and arrays. Establish a maintainable foundation for Phase 16's two-way sync feature.

Output: Fully refactored scripts sourcing common.sh, with yq-based frontmatter handling
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-library-extraction-yq-integration/15-RESEARCH.md
@.planning/phases/15-library-extraction-yq-integration/15-01-SUMMARY.md
@scripts/lib/common.sh
@scripts/publish.sh
@scripts/unpublish.sh
@scripts/list-posts.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation and utility functions to common.sh</name>
  <files>scripts/lib/common.sh</files>
  <action>
Add the following functions to common.sh (after the constants section):

**Validation Functions:**
1. `extract_frontmatter()` - Use yq --front-matter=extract for reliable parsing
   ```bash
   extract_frontmatter() {
     local file="$1"
     yq --front-matter=extract '.' "$file" 2>/dev/null
   }
   ```

2. `get_frontmatter_field()` - Extract specific field using yq
   ```bash
   get_frontmatter_field() {
     local file="$1"
     local field="$2"
     yq --front-matter=extract ".$field // \"\"" "$file" 2>/dev/null
   }
   ```

3. `validate_iso8601()` - Keep existing regex (validated, works well)
   ```bash
   validate_iso8601() {
     local datetime="$1"
     [[ "$datetime" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}(T[0-9]{2}:[0-9]{2}:[0-9]{2})? ]]
   }
   ```

4. `validate_frontmatter()` - Refactor to use yq functions
   - Check title, pubDatetime, description required fields
   - Return error messages on stdout, return 1 on failure

**Utility Functions:**
5. `slugify()` - Keep existing implementation (works correctly)
   - Lowercase, spaces to hyphens, remove special chars, collapse hyphens

6. `load_config()` - Load and validate settings.local.json
   - Check file exists, jq available, vault path valid
   - Set VAULT_PATH global variable
   - Print error messages and exit on failure

7. `extract_frontmatter_value()` - Alias to get_frontmatter_field for backward compat
   ```bash
   extract_frontmatter_value() {
     get_frontmatter_field "$1" "$2"
   }
   ```

**Important:** All functions use `local` for variables to prevent namespace pollution.

**yq Fallback:** For environments without yq, keep sed-based fallback in get_frontmatter_field:
```bash
get_frontmatter_field() {
  local file="$1"
  local field="$2"
  if command -v yq &>/dev/null && yq --version 2>&1 | grep -q "mikefarah"; then
    yq --front-matter=extract ".$field // \"\"" "$file" 2>/dev/null
  else
    # Fallback to sed (less reliable but works for simple cases)
    sed -n '/^---$/,/^---$/p' "$file" | grep -E "^${field}:" | head -1 | sed "s/^${field}:[[:space:]]*//" | sed 's/^["\x27]//' | sed 's/["\x27]$//' | tr -d '\r'
  fi
}
```
  </action>
  <verify>
1. shellcheck passes: `shellcheck scripts/lib/common.sh`
2. Functions work: Create test file with frontmatter, verify extraction:
   ```bash
   echo '---
   title: "Test: Quoted"
   pubDatetime: 2026-02-01T12:00:00
   description: A test post
   ---
   Content here' > /tmp/test-post.md

   source scripts/lib/common.sh
   get_frontmatter_field /tmp/test-post.md title  # Should output: Test: Quoted
   validate_frontmatter /tmp/test-post.md && echo "Valid"  # Should output: Valid
   slugify "Hello World Post"  # Should output: hello-world-post
   ```
3. Double-source still safe
  </verify>
  <done>
common.sh contains all validation and utility functions
Functions use yq for frontmatter extraction where available
shellcheck passes with no errors
All functions work correctly (tested with sample file)
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate scripts to source common.sh</name>
  <files>scripts/publish.sh, scripts/unpublish.sh, scripts/list-posts.sh, scripts/setup.sh, scripts/bootstrap.sh</files>
  <action>
Update each script to source common.sh and remove duplicated code:

**For all 5 scripts:**
1. Add SCRIPT_DIR and source line after shebang:
   ```bash
   #!/usr/bin/env bash
   # [existing description]
   set -euo pipefail

   # Source shared library
   SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
   source "${SCRIPT_DIR}/lib/common.sh"
   ```

2. Remove duplicated color constant definitions (RED, GREEN, YELLOW, CYAN, BLUE, RESET)

3. Remove duplicated config constants (CONFIG_FILE, BLOG_DIR, ASSETS_DIR, EXIT_*)

**For publish.sh, unpublish.sh, list-posts.sh (scripts with duplicated functions):**
4. Remove these functions (now in common.sh):
   - extract_frontmatter()
   - get_frontmatter_field()
   - validate_iso8601()
   - validate_frontmatter()
   - load_config()
   - slugify()
   - extract_frontmatter_value()

5. Keep script-specific functions:
   - publish.sh: rollback, lint/build, image handling, git operations, selection UI
   - unpublish.sh: resolve_post_path, confirm_removal, remove_post
   - list-posts.sh: list_posts, list_published_posts, filtering logic

**For setup.sh and bootstrap.sh:**
- Only remove color constants, keep other code (they have unique functionality)

**IMPORTANT:** Test each script individually after modification to ensure it still works.
  </action>
  <verify>
Run each script with --help to verify sourcing works:
```bash
scripts/publish.sh --help
scripts/unpublish.sh --help
scripts/list-posts.sh --help
scripts/setup.sh --help
scripts/bootstrap.sh --help
```

Run shellcheck on all scripts:
```bash
shellcheck -x scripts/*.sh scripts/lib/*.sh
```

Verify no duplicate definitions remain:
```bash
grep -l "readonly RED=" scripts/*.sh  # Should return nothing (only in common.sh)
grep -l "^slugify()" scripts/*.sh  # Should return nothing (only in common.sh)
```
  </verify>
  <done>
All 5 scripts source common.sh via BASH_SOURCE pattern
No duplicate color constants in any script
No duplicate functions in publish.sh, unpublish.sh, list-posts.sh
All scripts run with --help without errors
shellcheck passes on all files with -x flag
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify yq frontmatter handling</name>
  <files>scripts/lib/common.sh</files>
  <action>
Test that yq-based frontmatter extraction handles edge cases that sed/grep cannot:

Create test files and verify extraction:

1. **Quoted values with colons:**
   ```yaml
   title: "Part 1: The Beginning"
   ```
   Expected: `Part 1: The Beginning` (not truncated at colon)

2. **Single-quoted with apostrophe:**
   ```yaml
   title: "It's a Test"
   ```
   Expected: `It's a Test`

3. **Array values (tags):**
   ```yaml
   tags:
     - programming
     - bash
   ```
   Expected: Can read as array or first element

4. **Multiline description:**
   ```yaml
   description: |
     This is a long description
     that spans multiple lines.
   ```
   Expected: Full multiline content

5. **Empty/missing fields:**
   ```yaml
   title: Test
   # no description field
   ```
   Expected: Empty string for description, not "null"

If any test fails, the yq expressions need adjustment. Use `// ""` to handle nulls.

Document working yq patterns in code comments for future reference.
  </action>
  <verify>
Create test script and run:
```bash
cat > /tmp/test-yq.sh << 'EOF'
source scripts/lib/common.sh

# Test 1: Colon in value
echo '---
title: "Part 1: The Beginning"
pubDatetime: 2026-02-01
description: Test
---' > /tmp/test1.md
result=$(get_frontmatter_field /tmp/test1.md title)
[[ "$result" == "Part 1: The Beginning" ]] && echo "Test 1 PASS" || echo "Test 1 FAIL: got '$result'"

# Test 2: Apostrophe
echo "---
title: It's a Test
pubDatetime: 2026-02-01
description: Test
---" > /tmp/test2.md
result=$(get_frontmatter_field /tmp/test2.md title)
[[ "$result" == "It's a Test" ]] && echo "Test 2 PASS" || echo "Test 2 FAIL: got '$result'"

# Test 3: Missing field returns empty, not null
echo '---
title: Test
pubDatetime: 2026-02-01
---' > /tmp/test3.md
result=$(get_frontmatter_field /tmp/test3.md description)
[[ -z "$result" || "$result" == "" ]] && echo "Test 3 PASS" || echo "Test 3 FAIL: got '$result'"

echo "All tests complete"
EOF
bash /tmp/test-yq.sh
```
  </verify>
  <done>
yq correctly handles quoted values with colons
yq correctly handles apostrophes
yq returns empty string for missing fields (not "null")
All edge case tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `shellcheck -x scripts/*.sh scripts/lib/*.sh` - no errors
2. `scripts/publish.sh --help` - works
3. `scripts/unpublish.sh --help` - works
4. `scripts/list-posts.sh --help` - works
5. `scripts/setup.sh --help` - works
6. `scripts/bootstrap.sh --help` - works
7. No duplicate color constants: `grep -c "readonly RED=" scripts/*.sh` returns 0
8. yq edge cases work (colon in value, missing fields)
</verification>

<success_criteria>
- All validation/utility functions extracted to common.sh
- All 5 scripts source common.sh using BASH_SOURCE pattern
- No duplicated code remains in individual scripts
- shellcheck passes on all files
- yq-based extraction handles edge cases (quoted colons, missing fields)
- All scripts work correctly (--help, actual operations)
</success_criteria>

<output>
After completion, create `.planning/phases/15-library-extraction-yq-integration/15-02-SUMMARY.md`
</output>
