---
phase: 08-core-publishing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [scripts/publish.sh]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Frontmatter types match Astro content schema after transformation"
    - "Author array with wiki-link converted to site default string"
    - "Empty heroImage field stripped from output"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "normalize_frontmatter() function for type transformation"
      contains: "normalize_frontmatter"
  key_links:
    - from: "normalize_frontmatter()"
      to: "copy_post()"
      via: "called before convert_wiki_links()"
      pattern: "normalize_frontmatter.*convert_wiki_links"
---

<objective>
Fix frontmatter type mismatch causing Astro build failures

Purpose: Obsidian uses YAML array for author (`author:\n  - "[[Me]]"`) and empty heroImage (null),
but Astro schema expects `author: z.string().default(SITE.author)` and `heroImage: z.string().optional()`.
The null value fails validation because optional() expects undefined or string, not null.

Output: Build passes without InvalidContentEntryDataError for author/heroImage fields
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-publishing/08-UAT.md (gap diagnosis for Test 13)

Key files:
@scripts/publish.sh (add normalize_frontmatter function)
@src/content.config.ts (schema reference: author string, heroImage optional string)
@src/consts.ts (SITE.author = "Justin Carlson")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add normalize_frontmatter() function</name>
  <files>scripts/publish.sh</files>
  <action>
Add a new function `normalize_frontmatter()` in the Validation section (after `validate_frontmatter()`, around line 310).

The function should:
1. Take content as input, return normalized content
2. Handle author field:
   - Detect YAML array pattern: `author:\n  - ` (possibly with indentation variants)
   - Replace with `author: "Justin Carlson"` (hardcode site default - avoids dependency on config at this point)
   - Must handle wiki-link format: `author:\n  - "[[Me]]"` or `author:\n  - [[Me]]`
3. Handle heroImage field:
   - Detect empty heroImage: `heroImage:` followed by newline or end of frontmatter
   - Remove the line entirely (don't just set to empty string)

Implementation approach:
```bash
normalize_frontmatter() {
    local content="$1"

    # Replace author array with site default string
    # Pattern matches: author:\n  - "[[Me]]" or author:\n  - [[Me]] or author:\n  - "Name"
    content=$(echo "$content" | perl -0777 -pe 's/^author:\s*\n\s*-\s*.*$/author: "Justin Carlson"/m')

    # Remove empty heroImage lines (heroImage: followed by newline or nothing)
    content=$(echo "$content" | perl -pe 's/^heroImage:\s*$\n?//m')

    echo "$content"
}
```

Note: Use perl for multiline matching consistency with existing discover_posts() pattern.
  </action>
  <verify>
Test with sample input:
```bash
# Create test content
cat << 'EOF' > /tmp/test-frontmatter.md
---
title: "Test Post"
author:
  - "[[Me]]"
heroImage:
pubDatetime: 2026-01-31
---
Content here
EOF

# Source the function and test
source scripts/publish.sh 2>/dev/null || true
normalize_frontmatter "$(cat /tmp/test-frontmatter.md)"
```
Verify output has `author: "Justin Carlson"` and no heroImage line.
  </verify>
  <done>normalize_frontmatter() exists and correctly transforms author array to string, removes empty heroImage</done>
</task>

<task type="auto">
  <name>Task 2: Wire normalize_frontmatter() into copy_post()</name>
  <files>scripts/publish.sh</files>
  <action>
In the `copy_post()` function (around line 809), add a call to `normalize_frontmatter()`
BEFORE the call to `convert_wiki_links()`.

Current flow (lines 829-834):
```bash
# Read content
local content
content=$(cat "$source_path")

# Convert wiki-links to markdown
content=$(convert_wiki_links "$content" "$slug")
```

Change to:
```bash
# Read content
local content
content=$(cat "$source_path")

# Normalize frontmatter types (author array -> string, remove empty heroImage)
content=$(normalize_frontmatter "$content")

# Convert wiki-links to markdown
content=$(convert_wiki_links "$content" "$slug")
```

This order is important: normalize_frontmatter() must run BEFORE convert_wiki_links()
so that wiki-links in the author field (like `[[Me]]`) don't get converted to markdown
link syntax before being replaced with the site default.
  </action>
  <verify>
Run the full publish workflow:
```bash
just publish --dry-run
```
Then test with an actual post (if available) or create a test post in the vault.

Final verification: Run `npm run build` to confirm no InvalidContentEntryDataError.
  </verify>
  <done>copy_post() calls normalize_frontmatter() before convert_wiki_links(), build passes without schema errors</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run full build to confirm no schema validation errors:
   ```bash
   npm run build
   ```
   Expected: Build completes without InvalidContentEntryDataError

2. Inspect a published post to verify frontmatter:
   ```bash
   head -20 src/content/blog/*/some-post.md
   ```
   Expected: `author: "Justin Carlson"` (string, not array), no heroImage line if it was empty
</verification>

<success_criteria>
- npm run build passes without InvalidContentEntryDataError
- Author field is string format in published posts
- Empty heroImage fields are removed (not null)
- Existing wiki-link conversion still works
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-publishing/08-05-SUMMARY.md`
</output>
