---
phase: 08-core-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/publish.sh
  - justfile
autonomous: true

must_haves:
  truths:
    - "Running `just publish` starts the publish workflow"
    - "Script reads vault path from .claude/settings.local.json"
    - "Script finds all posts with `status: - Published` (case-insensitive)"
    - "Posts display as interactive multi-select list sorted newest first"
    - "Already-published identical posts are excluded; changed posts show as updates"
    - "No posts ready shows friendly message and exits cleanly"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Post discovery and multi-select UI"
      min_lines: 150
    - path: "justfile"
      provides: "publish recipe calling scripts/publish.sh"
      contains: "publish:"
  key_links:
    - from: "justfile"
      to: "scripts/publish.sh"
      via: "recipe invocation"
      pattern: "./scripts/publish.sh"
    - from: "scripts/publish.sh"
      to: ".claude/settings.local.json"
      via: "jq read for vault path"
      pattern: 'jq.*obsidianVaultPath'
---

<objective>
Create the publish recipe and post discovery logic for finding ready-to-publish posts in the configured Obsidian vault.

Purpose: Enable users to run `just publish` to discover posts marked with `status: - Published` in their Obsidian vault, with an interactive multi-select UI for choosing which posts to publish.

Output: `scripts/publish.sh` with post discovery and selection, `justfile` updated with publish recipe.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-publishing/08-CONTEXT.md
@.planning/phases/07-setup-safety/07-01-SUMMARY.md
@justfile
@scripts/setup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create publish script with post discovery</name>
  <files>scripts/publish.sh</files>
  <action>
Create `scripts/publish.sh` with:

1. **Config reading** (reuse pattern from setup.sh):
   - Read vault path from `.claude/settings.local.json` using jq
   - Error with helpful message if config missing or vault path not set

2. **Post discovery**:
   - Search entire vault for `.md` files with `status:` containing `Published` (case-insensitive)
   - Use grep -rl with YAML frontmatter pattern: `status:\s*-\s*[Pp]ublished`
   - For each found file, extract title and pubDatetime from frontmatter
   - Sort by pubDatetime descending (newest first)

3. **Already-published detection**:
   - For each discovered post, check if equivalent file exists in `src/content/blog/YYYY/`
   - Slug derived from Obsidian filename (slugified: lowercase, spaces to hyphens)
   - If exists and content identical (diff -q): exclude from list
   - If exists but different: include with "(update)" marker

4. **No posts scenario**:
   - If no posts found after filtering: echo "No posts ready to publish" and exit 0

5. **Interactive multi-select**:
   - Use `gum choose --no-limit` for checkbox-style selection (install check with fallback)
   - Display format: `[title] - [pubDatetime YYYY-MM-DD]`
   - If gum not available, fall back to fzf --multi, then to numbered selection

6. **Output selection**:
   - After selection, validate at least one post selected
   - Store selected file paths in array for next pipeline stages
   - Echo "Selected N post(s) for publishing"

Key patterns:
- Use `set -euo pipefail` for safety
- Color output (GREEN, YELLOW, RED) matching setup.sh style
- Structured functions for each concern (discover_posts, check_already_published, select_posts)
- Exit codes: 0 success, 1 error, 130 user cancelled
  </action>
  <verify>
Run `./scripts/publish.sh` (after `just setup` has run) - should search vault and either show selection UI or "No posts ready" message.
Test with a mock post in vault that has `status: - Published` frontmatter.
  </verify>
  <done>
Script discovers posts with `status: - Published`, shows multi-select UI, handles empty case gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add publish recipe to justfile</name>
  <files>justfile</files>
  <action>
Add to justfile after the Development section:

```just
# === Publishing ===

# Publish posts from Obsidian vault (interactive)
publish *args='':
    ./scripts/publish.sh {{args}}
```

The recipe:
- Takes optional args for future flags (--dry-run)
- Passes args through to script
- Placed in new "Publishing" section between Development and any future sections

Keep existing recipes unchanged. Maintain consistent formatting with existing file.
  </action>
  <verify>
Run `just --list` - should show publish recipe with description "Publish posts from Obsidian vault (interactive)".
Run `just publish` - should invoke scripts/publish.sh.
  </verify>
  <done>
`just publish` recipe exists and invokes publish script.
  </done>
</task>

</tasks>

<verification>
1. `just --list` shows publish recipe
2. `just publish` runs without error when no posts ready (shows friendly message)
3. Script reads vault path from config correctly
4. Posts with `status: - Published` are discovered
5. Multi-select UI displays when posts found
</verification>

<success_criteria>
- User can run `just publish` to start publish workflow
- Script correctly reads vault path from Phase 7 config
- Posts with `status: - Published` (any case) are discovered
- Interactive selection UI works (gum or fallback)
- Empty vault shows "No posts ready to publish" and exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-publishing/08-01-SUMMARY.md`
</output>
