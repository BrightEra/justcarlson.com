---
phase: 08-core-publishing
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - scripts/publish.sh
  - justfile
autonomous: true

must_haves:
  truths:
    - "Biome lint runs after posts/images copied, before any git commits"
    - "Full build (`npm run build`) runs after all commits, before any push"
    - "Lint failures block commits; build failures block push"
    - "Each post gets its own commit with conventional message"
    - "New posts: `docs(blog): add {title}`, updates: `docs(blog): update {title}`"
    - "User prompted before push to remote"
    - "On 3 failed fix attempts, all changes rolled back"
    - "`just publish --dry-run` shows all actions without executing"
    - "Progress messages shown for all major steps (discovery, validation, copy, lint, build, commit, push)"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Complete publish pipeline with lint, build, commit, push, dry-run"
      min_lines: 400
    - path: "justfile"
      provides: "publish recipe with dry-run support"
      contains: "--dry-run"
  key_links:
    - from: "scripts/publish.sh"
      to: "npm run lint"
      via: "Biome lint check"
      pattern: 'npm run lint'
    - from: "scripts/publish.sh"
      to: "npm run build"
      via: "Astro build verification"
      pattern: 'npm run build'
    - from: "scripts/publish.sh"
      to: "git commit"
      via: "conventional commit per post"
      pattern: 'git commit -m'
---

<objective>
Complete the publish pipeline with lint/build verification, git commit/push, failure recovery, and dry-run mode.

Purpose: Ensure all published content passes quality checks (lint, build) before committing, with automatic retry on failures, rollback after 3 failed attempts, and a dry-run mode for previewing actions.

Output: Complete `scripts/publish.sh` with full pipeline, updated `justfile` documenting --dry-run flag.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-publishing/08-CONTEXT.md
@.planning/phases/08-core-publishing/08-01-SUMMARY.md
@.planning/phases/08-core-publishing/08-02-SUMMARY.md
@scripts/publish.sh
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lint/build verification with retry and rollback</name>
  <files>scripts/publish.sh</files>
  <action>
Add verification pipeline to `scripts/publish.sh`:

1. **run_lint function**:
   - Execute `npm run lint`
   - Return exit code

2. **run_build function**:
   - Execute `npm run build`
   - Return exit code

3. **Verification pipeline** (timing is critical):
   - After all posts and images copied (before any git commits):
     a. Run lint (`npm run lint`)
     b. If lint fails: attempt fix (see retry logic)
     c. If lint passes: proceed to commits
   - After all posts committed (before any push):
     a. Run build (`npm run build`)
     b. If build fails: attempt fix (see retry logic)
   - Summary: copy -> lint -> commit -> build -> push

4. **Retry logic with Claude hook**:
   - On failure, output special marker for Claude hook to pick up:
     `echo "PUBLISH_LINT_FAILED" >&2` or `echo "PUBLISH_BUILD_FAILED" >&2`
   - Hook (if present) triggers Claude to analyze and fix
   - After fix attempt, auto-retry (no prompt)
   - Track attempt count (max 3)

5. **Rollback on 3 failures**:
   - If 3 attempts fail, rollback all changes:
     a. Remove copied posts from `src/content/blog/YYYY/`
     b. Remove copied images from `public/assets/blog/[slug]/`
     c. No git cleanup needed (nothing committed yet)
   - Output: "Publishing failed after 3 attempts. All changes rolled back."
   - Explain: "Your Obsidian files are unchanged. Fix issues and try again."
   - Exit 1

6. **Track modified files**:
   - Keep array of all files/directories created during this publish run
   - Used for rollback cleanup

Key patterns:
- Store created paths in CREATED_FILES and CREATED_DIRS arrays
- Rollback removes in reverse order
- Lint/build output captured and displayed on failure
- Progress reporting (JUST-14): echo step names before each major operation
  - "Running lint check..."
  - "Lint passed. Committing posts..."
  - "Running build verification..."
  - "Build passed. Ready to push."
  </action>
  <verify>
Test with valid content - lint and build should pass.
Test by introducing lint error - should show retry marker.
Verify rollback removes created files/directories.
  </verify>
  <done>
Lint and build run before commits. Failures trigger retry markers. After 3 failures, all changes rolled back.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add git commit/push and dry-run mode</name>
  <files>scripts/publish.sh, justfile</files>
  <action>
Add commit/push and dry-run to `scripts/publish.sh`:

1. **Commit logic**:
   - After lint/build pass, commit each post individually
   - For each post:
     a. Stage: post file + its images directory
     b. Determine if new or update (check git status)
     c. New post message: `docs(blog): add {title}`
     d. Update message: `docs(blog): update {title}`
     e. Execute `git commit -m "message"`
   - Total N commits for N posts

2. **Push logic**:
   - After all commits, prompt: "Push N commit(s) to remote? [Y/n]"
   - Default Y
   - If yes: `git push`
   - If no: "Commits created locally. Run 'git push' when ready."

3. **Dry-run mode**:
   - Check for `--dry-run` argument at script start
   - Set DRY_RUN=true if present
   - Throughout script, wrap mutating operations:
     ```bash
     if [[ "$DRY_RUN" == "true" ]]; then
       echo "[DRY-RUN] Would copy: $src -> $dest"
     else
       cp "$src" "$dest"
     fi
     ```
   - Dry-run shows:
     - Posts that would be copied (with paths)
     - Images that would be copied
     - Lint/build commands that would run
     - Commits that would be created (with messages)
     - Push that would happen
   - Dry-run skips validation prompts but shows what would be validated

4. **Dry-run output format**:
   ```
   === Dry Run ===

   Posts to publish:
     - "Hello World" -> src/content/blog/2026/hello-world.md (new)
     - "My Update" -> src/content/blog/2025/my-update.md (update)

   Images to copy:
     - photo.png -> public/assets/blog/hello-world/photo.png

   Validation:
     - Would run: npm run lint
     - Would run: npm run build

   Commits:
     - docs(blog): add Hello World
     - docs(blog): update My Update

   Push:
     - Would push 2 commits to origin
   ```

5. **Update justfile**:
   - Update publish recipe comment to mention --dry-run:
     `# Publish posts from Obsidian vault (use --dry-run to preview)`
  </action>
  <verify>
Test `just publish --dry-run` - should show planned actions without executing.
Test normal publish - should commit each post and prompt for push.
Verify commit messages use conventional format.
  </verify>
  <done>
Commits created per-post with conventional messages. Push prompts user. Dry-run shows complete preview of all actions.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` runs after copy, before commits
2. `npm run build` runs after commits, before push
3. Lint failures block commits; build failures block push
4. Retry marker output on failures
5. Rollback works after 3 failures
6. Each post gets individual commit
7. Commit messages follow convention (`docs(blog): add/update`)
8. Push prompts before executing
9. `just publish --dry-run` shows all planned actions
10. Dry-run executes no mutating operations
11. Progress messages shown for each major step (JUST-14)
</verification>

<success_criteria>
- Lint and build verification gate commits
- Retry mechanism with 3-attempt limit
- Full rollback on persistent failures
- Per-post conventional commits
- Interactive push confirmation
- Complete dry-run preview mode
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-publishing/08-03-SUMMARY.md`
</output>
