---
phase: 08-core-publishing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/publish.sh
  - .husky/pre-commit
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Post count displays with colored text (no literal escape codes)"
    - "Pipeline continues to build step after commit"
    - "Dry-run previews all actions without prompts"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "ANSI colors via echo -e, dry-run auto-continue"
      contains: "echo -e.*GREEN.*RESET"
    - path: ".husky/pre-commit"
      provides: "lint-staged with allow-empty"
      contains: "--allow-empty"
  key_links:
    - from: ".husky/pre-commit"
      to: "git commit"
      via: "lint-staged exit code"
      pattern: "npx lint-staged --allow-empty"
---

<objective>
Fix 3 UAT gaps from Phase 08 testing.

Purpose: Close diagnosed issues blocking dry-run mode and full pipeline execution
Output: Working publish pipeline with proper ANSI output, successful commits, and non-interactive dry-run
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-core-publishing/08-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ANSI escape code output</name>
  <files>scripts/publish.sh</files>
  <action>
On line 1090 of scripts/publish.sh, change:
```bash
echo "Found ${GREEN}${#POST_FILES[@]}${RESET} post(s) ready to publish"
```
to:
```bash
echo -e "Found ${GREEN}${#POST_FILES[@]}${RESET} post(s) ready to publish"
```

The `-e` flag enables interpretation of backslash escape sequences, which is required for the color variables (GREEN, RESET) to render correctly.
  </action>
  <verify>Run `just publish --dry-run` and confirm post count shows in green color, not literal `\033[0;32m` escape codes</verify>
  <done>Color output renders correctly in terminal</done>
</task>

<task type="auto">
  <name>Task 2: Fix lint-staged exit on markdown-only commits</name>
  <files>.husky/pre-commit</files>
  <action>
In `.husky/pre-commit`, change:
```sh
npx lint-staged
```
to:
```sh
npx lint-staged --allow-empty
```

The `--allow-empty` flag prevents lint-staged from exiting with code 1 when no files match its patterns (e.g., when only .md files are staged but lint-staged only covers .js/.ts/.json files).
  </action>
  <verify>Stage a .md file only, run `git commit -m "test"` - should not fail on lint-staged</verify>
  <done>Commits with markdown-only changes succeed without lint-staged error</done>
</task>

<task type="auto">
  <name>Task 3: Skip confirmation prompt in dry-run mode</name>
  <files>scripts/publish.sh</files>
  <action>
In scripts/publish.sh, modify the partial valid scenario block (around lines 347-360) to skip the interactive prompt when in dry-run mode.

Change:
```bash
if [[ ${#invalid_files[@]} -gt 0 && ${#valid_files[@]} -gt 0 ]]; then
    echo -e "${YELLOW}${#valid_files[@]} of ${#SELECTED_FILES[@]} posts are valid.${RESET}"
    read -rp "Publish the valid ones? [Y/n] " response

    if [[ "$response" =~ ^[Nn] ]]; then
        echo ""
        echo -e "${YELLOW}Cancelled. Fix validation errors and try again.${RESET}"
        exit $EXIT_SUCCESS
    fi

    # Continue with only valid files
    SELECTED_FILES=("${valid_files[@]}")
    echo ""
    echo -e "${GREEN}Continuing with ${#SELECTED_FILES[@]} valid post(s)${RESET}"
```
to:
```bash
if [[ ${#invalid_files[@]} -gt 0 && ${#valid_files[@]} -gt 0 ]]; then
    echo -e "${YELLOW}${#valid_files[@]} of ${#SELECTED_FILES[@]} posts are valid.${RESET}"

    if [[ "$DRY_RUN" == "true" ]]; then
        # Auto-continue in dry-run mode
        echo -e "${CYAN}Dry run: auto-continuing with valid posts${RESET}"
    else
        read -rp "Publish the valid ones? [Y/n] " response

        if [[ "$response" =~ ^[Nn] ]]; then
            echo ""
            echo -e "${YELLOW}Cancelled. Fix validation errors and try again.${RESET}"
            exit $EXIT_SUCCESS
        fi
    fi

    # Continue with only valid files
    SELECTED_FILES=("${valid_files[@]}")
    echo ""
    echo -e "${GREEN}Continuing with ${#SELECTED_FILES[@]} valid post(s)${RESET}"
```
  </action>
  <verify>Run `just publish --dry-run` with a post that has validation issues - should auto-continue without prompting</verify>
  <done>Dry-run mode completes full preview without any interactive prompts</done>
</task>

</tasks>

<verification>
1. Run `just publish --dry-run` with a valid post:
   - Post count shows green color (not escape codes)
   - Preview completes without prompts

2. Create a test commit with only .md file staged:
   - Commit succeeds (lint-staged doesn't fail)

3. Run `just publish --dry-run` with a post missing required fields:
   - Shows validation errors
   - Auto-continues with valid posts (no prompt)
   - Completes full dry-run preview
</verification>

<success_criteria>
- All 3 UAT gaps closed
- `just publish --dry-run` runs non-interactively from start to finish
- `just publish` pipeline reaches build step after commits
- Terminal output shows proper ANSI colors
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-publishing/08-04-SUMMARY.md`
</output>
