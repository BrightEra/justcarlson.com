---
phase: 08-core-publishing
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/publish.sh
autonomous: true

must_haves:
  truths:
    - "Posts missing title, pubDatetime, or description show validation errors"
    - "All errors collected and displayed at once (not fail-fast)"
    - "Partial valid scenario prompts user to continue with valid posts only"
    - "Wiki-style image links `![[image.png]]` converted to markdown"
    - "Local images copied to `public/assets/blog/[slug]/`"
    - "Remote image URLs left unchanged"
    - "Missing local images warned but don't block publishing"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Validation and image handling functions"
      contains: "validate_frontmatter"
  key_links:
    - from: "scripts/publish.sh"
      to: "public/assets/blog/[slug]/"
      via: "mkdir and cp for images"
      pattern: 'public/assets/blog'
    - from: "scripts/publish.sh"
      to: "src/content/blog/YYYY/"
      via: "post file copy"
      pattern: 'src/content/blog'
---

<objective>
Add frontmatter validation and image handling to the publish script, including wiki-link conversion and copying local images to the correct asset directories.

Purpose: Ensure posts have valid required fields before publishing and handle image references correctly, converting Obsidian wiki-links to standard markdown and copying local images to the Astro public directory.

Output: Updated `scripts/publish.sh` with validation and image processing capabilities.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-publishing/08-CONTEXT.md
@.planning/phases/08-core-publishing/08-01-SUMMARY.md
@scripts/publish.sh
@src/content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add frontmatter validation</name>
  <files>scripts/publish.sh</files>
  <action>
Add validation function to `scripts/publish.sh`:

1. **validate_frontmatter function**:
   - Takes file path as argument
   - Extracts YAML frontmatter (content between first two `---` lines)
   - Required fields: title, pubDatetime, description
   - Returns array of missing/invalid fields (empty array = valid)
   - Error format: "Missing title (required for SEO and display)"

2. **Validation integration**:
   - After post selection, validate all selected posts
   - Collect ALL errors across ALL posts (not fail-fast)
   - Display errors grouped by file

3. **Partial valid handling**:
   - Count valid vs invalid posts
   - If some valid, some invalid: prompt user
   - Prompt: "2 of 3 posts are valid. Publish the valid ones? [Y/n]"
   - If user declines, exit 0
   - If user confirms, continue with valid posts only

4. **Field extraction helpers**:
   - Use grep/sed to extract field values from frontmatter
   - Handle multiline values for description
   - pubDatetime: validate ISO 8601 format (YYYY-MM-DDTHH:MM:SS)
   - title: non-empty string
   - description: non-empty string

Key patterns:
- Store validation results in associative array keyed by filepath
- Display errors with file path context
- Yellow color for warnings, red for errors
  </action>
  <verify>
Test with posts missing required fields - should show all errors at once.
Test with mix of valid/invalid posts - should prompt for partial publish.
Test with all valid posts - should proceed without prompt.
  </verify>
  <done>
Validation catches missing/invalid frontmatter and reports all errors at once. Partial valid scenario works with user prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add image handling and wiki-link conversion</name>
  <files>scripts/publish.sh</files>
  <action>
Add image processing functions to `scripts/publish.sh`:

1. **extract_images function**:
   - Takes post content as argument
   - Find wiki-style: `![[image.png]]` -> extract `image.png`
   - Find markdown-style: `![alt](path)` -> extract `path` (skip if http/https)
   - Return array of local image references

2. **find_local_image function**:
   - Takes image filename and vault path
   - Search in vault's Attachments folder: `{vault}/Attachments/{image}`
   - Return full path if found, empty if not

3. **convert_wiki_links function**:
   - Takes post content as argument
   - Convert `![[image.png]]` to `![image.png](/assets/blog/[slug]/image.png)`
   - Preserve existing markdown-style local images but rewrite path
   - Remote URLs (http/https) left unchanged
   - Return converted content

4. **copy_images function**:
   - Takes slug and array of image paths
   - Create `public/assets/blog/[slug]/` directory
   - Copy each image to destination
   - For missing images: warn but don't fail

5. **copy_post function**:
   - Takes source path, slug, and year
   - Create `src/content/blog/YYYY/` if needed
   - Convert wiki-links in content
   - Write to `src/content/blog/YYYY/[slug].md`

6. **Integration**:
   - After validation passes, process each selected post:
     a. Derive slug from filename
     b. Extract year from pubDatetime
     c. Extract and copy images
     d. Convert content and copy post
   - Report progress: "Processing: [title]..."
   - Report warnings: "Warning: Image not found: xyz.png"

Key patterns:
- Slug derivation: lowercase, replace spaces with hyphens, remove special chars
- Year extraction: first 4 characters of pubDatetime
- Image warning doesn't block (exit 0 still possible)
  </action>
  <verify>
Test with post containing wiki-style image links - should convert and copy images.
Test with post containing markdown-style local images - should copy images.
Test with missing image - should warn but not fail.
Test with remote URLs - should leave unchanged.
  </verify>
  <done>
Wiki-links converted to markdown. Local images copied to public/assets/blog/[slug]/. Missing images warned but don't block. Remote URLs preserved.
  </done>
</task>

</tasks>

<verification>
1. Posts with missing fields show validation errors
2. All errors displayed at once across all posts
3. Partial valid scenario prompts correctly
4. Wiki-style `![[image]]` converted to markdown
5. Local images copied to `public/assets/blog/[slug]/`
6. Missing images produce warning only
7. Remote URLs unchanged
8. Progress messages shown: "Validating...", "Processing: {title}...", "Copying images..." (JUST-14)
</verification>

<success_criteria>
- Validation catches missing required fields with helpful messages
- All errors collected before displaying (not fail-fast)
- User can choose to publish valid-only when some invalid
- Wiki-links converted correctly
- Images copied to correct slug-based folders
- Remote URLs preserved unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-publishing/08-02-SUMMARY.md`
</output>
