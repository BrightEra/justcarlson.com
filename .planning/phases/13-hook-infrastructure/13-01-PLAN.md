---
phase: 13-hook-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/hooks/session_start.py
  - .claude/settings.json
  - .claude/hooks/blog-session-start.sh
autonomous: true

must_haves:
  truths:
    - "SessionStart hook runs Python with uv on session start"
    - "Hook loads .env variables into CLAUDE_ENV_FILE for bash persistence"
    - "Hook logs to file with timestamps for debugging"
    - "Hook checks vault config and reports posts-ready status"
    - "Hook completes within 10s timeout"
    - "Hook provides context to Claude via additionalContext"
  artifacts:
    - path: ".claude/hooks/session_start.py"
      provides: "Python SessionStart hook"
      contains: "#!/usr/bin/env -S uv run --script"
    - path: ".claude/hooks/session_start.log"
      provides: "Log file for debugging"
      min_lines: 5
    - path: ".claude/settings.json"
      provides: "Hook configuration"
      contains: "session_start.py"
  key_links:
    - from: ".claude/settings.json"
      to: ".claude/hooks/session_start.py"
      via: "hooks.SessionStart command"
      pattern: "session_start\\.py"
    - from: ".claude/hooks/session_start.py"
      to: "CLAUDE_ENV_FILE"
      via: "export statements"
      pattern: "CLAUDE_ENV_FILE"
    - from: ".claude/hooks/session_start.py"
      to: ".claude/settings.local.json"
      via: "vault path lookup"
      pattern: "obsidianVaultPath"
---

<objective>
Convert the bash SessionStart hook to Python with robust infrastructure following install-and-maintain patterns.

Purpose: Replace fragile bash script with maintainable Python that has proper logging, env loading, and error handling. This enables debugging hook issues and ensures consistent environment setup across sessions.

Output:
- `.claude/hooks/session_start.py` - New Python hook with Logger class, log rotation, env loading, vault checking
- Updated `.claude/settings.json` pointing to Python script
- Removed `blog-session-start.sh` (bash script no longer needed)
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-hook-infrastructure/13-CONTEXT.md
@.planning/phases/13-hook-infrastructure/13-RESEARCH.md

# Reference implementation
@/home/jc/developer/install-and-maintain/.claude/hooks/session_start.py

# Current implementations to convert
@.claude/hooks/blog-session-start.sh
@.claude/settings.json
@.claude/settings.local.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python SessionStart hook</name>
  <files>.claude/hooks/session_start.py</files>
  <action>
Create `.claude/hooks/session_start.py` following the install-and-maintain reference implementation with these adaptations:

**Structure (from reference):**
- Shebang: `#!/usr/bin/env -S uv run --script`
- PEP 723 inline deps: `python-dotenv`
- requires-python: `>=3.11`
- Logger class with dual output (stderr + file)

**Blog-specific additions:**

1. **Log rotation on startup:**
   - Keep last 500 lines (~100 sessions)
   - Implement `rotate_log(log_path: Path, max_lines: int = 500)`
   - Call before creating Logger instance

2. **Env loading (from reference):**
   - Read `.env` from project root via `dotenv_values()`
   - Write exports to `CLAUDE_ENV_FILE` with single-quote escaping
   - Log each loaded variable name (not value)

3. **Vault checking (port from bash):**
   - Read `obsidianVaultPath` from `.claude/settings.local.json`
   - If no config or no vault path: message "No vault configured. Run /blog:install to set up publishing."
   - If vault path but directory missing: message "Vault path configured but not found: [path]"
   - If vault exists: count published posts using regex `status:\s*\n\s*-\s*[Pp]ublished`
     - 0 posts: "Vault connected. No posts ready to publish."
     - N posts: "Ready: N post(s) with Published status. Run /blog:publish to continue."

4. **Output format:**
   - JSON to stdout: `{"hookSpecificOutput": {"hookEventName": "SessionStart", "additionalContext": "..."}}`
   - Always output valid JSON, even on error

5. **Error handling:**
   - Wrap main logic in try/except
   - On error: log to file, output JSON with error message, exit 0 (don't block session)
   - Handle: missing files, JSON parse errors, .env syntax errors

**Do NOT:**
- Include the MOCK_SESSION_VAR from reference (that was for testing)
- Use `load_dotenv()` - use `dotenv_values()` and iterate
- Block on errors - always exit 0 with valid JSON
  </action>
  <verify>
```bash
# Check script exists and has correct shebang
head -5 .claude/hooks/session_start.py | grep -q "uv run --script"

# Check it's executable (or make it executable)
chmod +x .claude/hooks/session_start.py

# Test syntax
python3 -m py_compile .claude/hooks/session_start.py

# Test with mock input (no CLAUDE_ENV_FILE, should handle gracefully)
echo '{"source": "test", "session_id": "test-123"}' | .claude/hooks/session_start.py 2>/dev/null | jq .
```
  </verify>
  <done>
- session_start.py exists with PEP 723 header and python-dotenv dependency
- Script parses JSON input and outputs valid JSON
- Logger class writes to both stderr and .claude/hooks/session_start.log
- Log rotation keeps last 500 lines
- Vault checking logic matches bash behavior
  </done>
</task>

<task type="auto">
  <name>Task 2: Update settings and remove bash script</name>
  <files>.claude/settings.json, .claude/hooks/blog-session-start.sh</files>
  <action>
1. **Update `.claude/settings.json`:**
   - Change SessionStart hook command from `blog-session-start.sh` to `session_start.py`
   - Keep timeout at 10 (already configured)
   - Preserve all other hooks (PreToolUse git-safety.sh)

   Before:
   ```json
   "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/blog-session-start.sh"
   ```

   After:
   ```json
   "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/session_start.py"
   ```

2. **Remove old bash script:**
   - Delete `.claude/hooks/blog-session-start.sh`
   - It's fully replaced by session_start.py

3. **Verify settings.json is valid JSON after edit**
  </action>
  <verify>
```bash
# Verify JSON is valid
jq . .claude/settings.json

# Verify hook points to Python script
jq '.hooks.SessionStart[0].hooks[0].command' .claude/settings.json | grep -q "session_start.py"

# Verify timeout is 10s
jq '.hooks.SessionStart[0].hooks[0].timeout' .claude/settings.json | grep -q "10"

# Verify old bash script removed
test ! -f .claude/hooks/blog-session-start.sh && echo "Bash script removed"
```
  </verify>
  <done>
- settings.json points to session_start.py
- Timeout remains 10 seconds
- blog-session-start.sh is deleted
- All other hooks (git-safety) preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration test</name>
  <files></files>
  <action>
Run the Python hook in the project context to verify end-to-end behavior:

1. **Test with vault configured (current setup):**
   - The hook should read settings.local.json
   - Find the vault path
   - Count published posts
   - Output appropriate message via additionalContext

2. **Test without vault (portability scenario):**
   - Temporarily rename settings.local.json
   - Run hook
   - Verify "No vault configured" message
   - Restore settings.local.json

3. **Verify log file created:**
   - Check .claude/hooks/session_start.log exists after run
   - Contains timestamp and session info

4. **Verify env loading:**
   - Create temporary .env with test var
   - Create temporary CLAUDE_ENV_FILE path
   - Run hook
   - Check CLAUDE_ENV_FILE contains export statement
   - Clean up test files
  </action>
  <verify>
```bash
# Full integration test
cd /home/jc/developer/justcarlson.com

# Test 1: Normal run with vault
echo '{"source": "test", "session_id": "integration-test"}' | .claude/hooks/session_start.py 2>/dev/null | jq -r '.hookSpecificOutput.additionalContext'

# Test 2: Check log file
test -f .claude/hooks/session_start.log && echo "Log file created"
tail -5 .claude/hooks/session_start.log

# Test 3: Without vault config
mv .claude/settings.local.json .claude/settings.local.json.bak 2>/dev/null || true
echo '{}' | .claude/hooks/session_start.py 2>/dev/null | jq -r '.hookSpecificOutput.additionalContext' | grep -q "No vault configured"
mv .claude/settings.local.json.bak .claude/settings.local.json 2>/dev/null || true
```
  </verify>
  <done>
- Hook runs successfully with vault configured
- Hook handles missing vault config gracefully
- Log file is created with timestamps
- JSON output is valid in all scenarios
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Python hook functional:**
   ```bash
   echo '{"source":"verify"}' | .claude/hooks/session_start.py 2>/dev/null | jq .
   ```
   Expected: Valid JSON with hookSpecificOutput.additionalContext

2. **Settings configured:**
   ```bash
   jq '.hooks.SessionStart[0].hooks[0]' .claude/settings.json
   ```
   Expected: command contains session_start.py, timeout is 10

3. **Old script removed:**
   ```bash
   ls .claude/hooks/*.sh
   ```
   Expected: Only git-safety.sh and verify-*.sh remain

4. **Log rotation works:**
   ```bash
   wc -l .claude/hooks/session_start.log
   ```
   Expected: <= 500 lines (or thereabouts after test runs)
</verification>

<success_criteria>
Phase 13 success when all are TRUE:
1. `session_start.py` runs with `uv run --script` shebang
2. Hook loads .env into CLAUDE_ENV_FILE (when file exists)
3. Hook logs to session_start.log with timestamps
4. Hook checks vault and reports post count
5. Hook completes within 10s (timeout in settings.json)
6. Hook outputs additionalContext for Claude visibility
7. Old bash script removed
</success_criteria>

<output>
After completion, create `.planning/phases/13-hook-infrastructure/13-01-SUMMARY.md`
</output>
