---
phase: 07-setup-safety
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .claude/settings.json
  - .claude/hooks/git-safety.sh
autonomous: true

must_haves:
  truths:
    - "Running `claude --init` triggers setup script automatically"
    - "Dangerous git operations are blocked with clear error messages"
    - "Block messages explain what was blocked and why"
    - "Non-dangerous git operations proceed normally"
  artifacts:
    - path: ".claude/settings.json"
      provides: "Hook configuration"
      contains: "PreToolUse"
    - path: ".claude/hooks/git-safety.sh"
      provides: "Git safety validation"
      min_lines: 30
  key_links:
    - from: ".claude/settings.json"
      to: "scripts/setup.sh"
      via: "Setup hook triggers script"
      pattern: "scripts/setup.sh"
    - from: ".claude/settings.json"
      to: ".claude/hooks/git-safety.sh"
      via: "PreToolUse hook calls safety script"
      pattern: "git-safety.sh"
---

<objective>
Configure Claude Code hooks for automatic setup on init and git safety protection.

Purpose: Ensure setup runs automatically when Claude initializes in this project, and protect against accidental destructive git operations that could cause data loss.

Output: Working hooks that trigger setup and block dangerous git commands.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/07-STACK.md
@.planning/phases/07-setup-safety/07-CONTEXT.md
@.planning/phases/07-setup-safety/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude hooks configuration</name>
  <files>.claude/settings.json</files>
  <action>
Create `.claude/settings.json` with hook configuration:

1. Setup hook (triggers on `claude --init`):
   - matcher: "init"
   - type: "command"
   - command: `"$CLAUDE_PROJECT_DIR"/scripts/setup.sh`
   - Note: Use double quotes around $CLAUDE_PROJECT_DIR for paths with spaces

2. PreToolUse hook for git safety (triggers on Bash tool):
   - matcher: "Bash"
   - type: "command"
   - command: `"$CLAUDE_PROJECT_DIR"/.claude/hooks/git-safety.sh`

JSON structure:
```json
{
  "hooks": {
    "Setup": [
      {
        "matcher": "init",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/scripts/setup.sh"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/git-safety.sh"
          }
        ]
      }
    ]
  }
}
```

This file should be committed to git (shared across machines).
  </action>
  <verify>
1. Verify `.claude/settings.json` is valid JSON: `jq . .claude/settings.json`
2. Verify both Setup and PreToolUse hooks are defined
3. Verify file is tracked by git: `git status` shows it as new file
  </verify>
  <done>
`.claude/settings.json` exists with Setup hook for init and PreToolUse hook for Bash commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create git safety hook script</name>
  <files>.claude/hooks/git-safety.sh</files>
  <action>
Create `.claude/hooks/git-safety.sh` with:

1. Shebang and strict mode:
   ```bash
   #!/usr/bin/env bash
   set -euo pipefail
   ```

2. Read JSON input from stdin (Claude passes tool input as JSON)

3. Extract command from `tool_input.command` using jq:
   ```bash
   INPUT=$(cat)
   COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // ""')
   ```

4. Define dangerous patterns to block (from 07-CONTEXT.md decisions):
   - `git push --force`
   - `git push -f`
   - `git reset --hard`
   - `git checkout .` (discard all changes)
   - `git restore .` (discard all changes)
   - `git clean -f` (delete untracked files)

   Note: Do NOT block `git branch -D` or `git rebase` per context decisions.

5. Pattern matching loop:
   - For each pattern, check if COMMAND contains it
   - Use bash regex: `[[ "$COMMAND" =~ $pattern ]]`

6. Block behavior (exit 2):
   - Print to stderr: "BLOCKED: [operation description]"
   - Print to stderr: Brief explanation of risk
   - Log to file: `.claude/blocked-operations.log` with timestamp
   - Exit with code 2 (tells Claude operation was blocked)

7. Allow behavior (exit 0):
   - If no patterns match, exit 0 (allow operation)

Make script executable: `chmod +x .claude/hooks/git-safety.sh`

Error message style (from context):
- Professional and direct tone
- Red color for "BLOCKED:" prefix
- Include what was blocked and why
- No bypass instructions (per context: use terminal directly)
  </action>
  <verify>
1. Test with safe command:
   ```bash
   echo '{"tool_input":{"command":"git status"}}' | .claude/hooks/git-safety.sh
   echo $?  # Should be 0
   ```

2. Test with dangerous commands:
   ```bash
   echo '{"tool_input":{"command":"git push --force origin main"}}' | .claude/hooks/git-safety.sh 2>&1
   echo $?  # Should be 2

   echo '{"tool_input":{"command":"git reset --hard HEAD~1"}}' | .claude/hooks/git-safety.sh 2>&1
   echo $?  # Should be 2

   echo '{"tool_input":{"command":"git checkout ."}}' | .claude/hooks/git-safety.sh 2>&1
   echo $?  # Should be 2
   ```

3. Test allowed operations (should NOT be blocked):
   ```bash
   echo '{"tool_input":{"command":"git branch -D feature"}}' | .claude/hooks/git-safety.sh
   echo $?  # Should be 0 (allowed per context)
   ```
  </verify>
  <done>
Git safety hook blocks dangerous operations with exit code 2 and clear error messages, allows all other git commands.
  </done>
</task>

</tasks>

<verification>
1. `.claude/settings.json` exists and is valid JSON
2. Setup hook points to `scripts/setup.sh`
3. PreToolUse hook points to `.claude/hooks/git-safety.sh`
4. Git safety hook blocks: `--force`, `reset --hard`, `checkout .`, `restore .`, `clean -f`
5. Git safety hook allows: normal git operations, `branch -D`, `rebase`
6. Block messages are professional and explain the risk
</verification>

<success_criteria>
- Claude hooks configuration is committed and valid
- Setup hook triggers on init (calls setup.sh)
- Git safety hook blocks dangerous operations
- Non-dangerous operations pass through
- Error messages are clear and professional
</success_criteria>

<output>
After completion, create `.planning/phases/07-setup-safety/07-02-SUMMARY.md`
</output>
